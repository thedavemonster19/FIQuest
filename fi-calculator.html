<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Independence Calculator</title>
    <script src="chart.min.js"></script>    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            background-color: #1a1a2e;
        }

        /* Typography System */
        h1, .text-xl { font-size: 28px; font-weight: 300; line-height: 1.2; }
        h2, .text-lg { font-size: 24px; font-weight: 500; line-height: 1.3; }
        h3, .text-md { font-size: 18px; font-weight: 500; line-height: 1.4; }
        h4, .text-sm { font-size: 16px; font-weight: 500; line-height: 1.4; }
        .text-xs { font-size: 14px; font-weight: 400; line-height: 1.4; }
        .text-micro { font-size: 12px; font-weight: 400; line-height: 1.3; }

        .font-light { font-weight: 300; }
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #16213e;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 30px;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 400;
            box-sizing: border-box;
            font-family: inherit;
        }

        input[readonly] {
            background-color: #1a1a2e;
            color: #6c757d;
            border: 1px solid #3a3a5a;
            cursor: not-allowed;
            font-weight: 500;
        }
        
        .calculate-btn {
            background-color: #D3AF37;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            font-family: inherit;
        }

        .control-buttons .calculate-btn {
            margin: 0;
            display: inline-flex;
            align-items: center;
        }
        
        .calculate-btn:hover {
            background-color: #B8941E;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .key-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #D3AF37;
        }
        
        .result-card h3 {
            margin: 0 0 10px 0;
            color: #ffffff;
        }
        
        .result-card .value {
            font-size: 18px;
            font-weight: bold;
            color: #D3AF37;
        }
        
        .chart-container {
            margin: 30px 0;
            height: 400px;
            position: relative;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #1a1a2e;
            font-weight: bold;
            color: #ffffff;
        }
        
        .status-building {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .status-fi {
            color: #D3AF37;
            font-weight: bold;
        }
        
        .fi-row {
            background-color: #e8f5e8;
        }
        
        #results {
            display: none;
        }
        
        .debt-section {
            margin: 30px 0;
            padding: 20px;
            background: #1a1a2e;
            border-radius: 10px;
        }
        
        .debt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .debt-section h2 {
            color: #ffffff;
            margin: 0;
            flex-grow: 1;
        }
        
        .debt-toggle-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        .debt-toggle-btn:hover {
            background: #1976D2;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        
        .debt-toggle-btn.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        .debt-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
        }
        
        .debt-content.show {
            max-height: 2000px;
            opacity: 1;
        }
        
        .debt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .debt-item {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .debt-item h3 {
            margin: 0 0 15px 0;
            color: #ffffff;
            text-align: center;
            font-size: 18px;
            border-bottom: 2px solid #D3AF37;
            padding-bottom: 10px;
        }
        
        .debt-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .debt-inputs .input-group {
            margin-bottom: 0;
        }
        
        .debt-inputs label {
            font-size: 14px;
            font-weight: 500;
        }

        .debt-inputs input,
        .debt-inputs select {
            padding: 10px;
            font-size: 14px;
            font-weight: 400;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            width: 85%;
            box-sizing: border-box;
        }
        
        .scenario-controls {
            margin: 30px 0;
            text-align: center;
        }
        
        .scenario-controls .input-group {
            max-width: 300px;
            margin: 0 auto 20px auto;
        }
        
        .control-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .clear-btn {
            background-color: #f44336;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        
        .scenario-result {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .scenario-1 { background-color: rgba(211, 175, 55, 0.1); border-left: 4px solid #D3AF37; }
        .scenario-2 { background-color: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; }
        .scenario-3 { background-color: rgba(255, 152, 0, 0.05); border-left: 4px solid #FF9800; }
        
        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
            cursor: help;
            vertical-align: top;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #2a2a4a;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip-container:hover .tooltip-text,
        .tooltip-container.active .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .label-with-tooltip {
            display: flex;
            align-items: center;
        }
        
        .disclaimer {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background-color: #1a1a2e;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .disclaimer h3 {
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .disclaimer p {
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            text-align: justify;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
                margin: 0 10px;
            }
            
            .input-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .debt-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .key-results {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            input, 
            .debt-inputs input, 
            .debt-inputs select {
                width: 100%;
                font-size: 16px;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .calculate-btn, 
            .clear-btn {
                width: 100%;
                max-width: 300px;
                margin: 10px 0;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .tooltip-text {
                width: 250px;
                margin-left: -125px;
                font-size: 12px;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }

        /* SPA Navigation Styles */
        .app-container {
            min-height: 100vh;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #0E0E55 0%, #0E0E55 100%);
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .app-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: white;
            text-align: left;
            line-height: 1.3;
        }

        .user-info {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 5px;
            line-height: 1.4;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 16px;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-menu a.active {
            background: rgba(255,255,255,0.2);
            font-weight: bold;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* Collapsible Navigation Styles */
        .nav-section {
            margin: 5px 0;
        }

        .nav-section-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-section-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .toggle-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .nav-subsection {
            background: rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-subitem {
            display: flex;
            align-items: center;
            padding: 10px 20px 10px 40px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-subitem:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-subitem.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: bold;
        }

        .nav-subitem:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 45px !important;
        }

        .nav-subitem.active {
            background: rgba(255,255,255,0.15);
            border-right: 3px solid #fff;
            color: white !important;
        }

        .main-content {
            margin-left: 250px;
            padding: 0;
            background: #1a1a2e;
            min-height: 100vh;
        }

        .page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .container {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page.hidden {
            display: none;
        }

        .page-header {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-title {
            margin: 0;
            color: #495057;
            font-size: 28px;
            font-weight: 300;
            text-align: center;
            line-height: 1.2;
        }

        .page-subtitle {
            color: #6c757d;
            margin: 8px 0 0 0;
            font-size: 16px;
            font-weight: 400;
            text-align: center;
            line-height: 1.4;
        }

        /* Full-width scenario info on desktop */
        .scenario-info-full-width {
            grid-column: 1 / -1;
        }
        
        /* Responsive design */
        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #D3AF37;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .mobile-menu-btn:hover {
            background: #B8941E;
        }

        /* Mobile Responsive CSS */
        @media (max-width: 480px) {
            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .page {
                padding: 20px 10px 20px 10px;
            }

            .scenario-info-full-width {
                grid-column: auto;
            }
        }
    </style>
    <script src="user-manager.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Mobile menu button -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">FIQuest</h1>
                <div class="user-info">Financial Independence Journey</div>
            </div>
            <div class="nav-menu">
                <a href="my-scenario.html" id="nav-scenarios">
                    <span class="nav-icon">📊</span>
                    My Scenario
                </a>
                <a href="net-worth-tracking.html" id="nav-net-worth-tracking">
                    <span class="nav-icon">📈</span>
                    Net Worth Tracking
                </a>
                <a href="data-management.html" id="nav-data-management">
                    <span class="nav-icon">💾</span>
                    Data Management
                </a>

                <!-- Collapsible Initial Setup Section -->
                <div class="nav-section">
                    <a href="#" class="nav-section-toggle" onclick="toggleInitialSetup(event)">
                        <span class="nav-icon">⚙️</span>
                        Initial Setup
                        <span class="toggle-arrow" id="setup-arrow">▼</span>
                    </a>
                    <div class="nav-subsection" id="initial-setup-section">
                        <a href="fi-calculator.html?access=intentional" class="active nav-subitem" id="nav-fi-calculator">
                            <span class="nav-icon">🧮</span>
                            FI Calculator
                        </a>
                        <a href="net-worth.html" id="nav-net-worth" class="nav-subitem">
                            <span class="nav-icon">💰</span>
                            Net Worth Setup
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- FI Calculator Page (existing content) -->
            <div id="page-fi-calculator" class="page">
                <div class="page-header">
                    <h1 class="page-title">Financial Independence Calculator</h1>
                    <p class="page-subtitle">Plan your path to financial freedom</p>
                </div>
                <div class="container">

        <div class="input-section">
            <!-- 1. Initial Age -->
            <div class="input-group">
                <label for="currentAge">Initial Age</label>
                <input type="number" id="currentAge" value="45" step="1">
            </div>
            
            <!-- 2. Active Until Age -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="activeUntilAge">Active Until Age</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">What year do you think you may start to spend less, be less physically active. Think about your older relatives and how you think you would compare at their age in terms of activities, spending, desires, etc.</span>
                    </div>
                </div>
                <input type="number" id="activeUntilAge" value="70" step="1">
            </div>
            
            <!-- 3. Life Expectancy -->
            <div class="input-group">
                <label for="lifeExpectancy">Life Expectancy</label>
                <input type="number" id="lifeExpectancy" value="90" step="1">
            </div>
            
            <!-- 4. Starting Capital -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="startingCapital">Starting Capital ($)</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">Amount invested or available to invest in Exchange Traded Funds (ETFs), Index Funds, Stocks, Real Estate, etc.</span>
                    </div>
                    <button type="button" id="toggleAccountDetails" onclick="toggleAccountView()" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">Hide Account Details</button>
                </div>
                <input type="text" id="startingCapital" value="150,000" readonly>
                
                <!-- Account Details Section (showing by default) -->
                <div id="accountDetailsSection" style="display: block; margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                    <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px; font-weight: 500;">Investment Accounts</h4>
                    
                    <div class="account-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <input type="text" id="account1Name" value="RRSP1" onchange="syncAccountNames()" style="width: 150px; margin-right: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </label>
                        <input type="text" id="account1Value" value="50,000" onchange="formatCurrencyInput(this); updateTotalStartingCapital()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>
                    
                    <div class="account-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <input type="text" id="account2Name" value="RRSP2" onchange="syncAccountNames()" style="width: 150px; margin-right: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </label>
                        <input type="text" id="account2Value" value="40,000" onchange="formatCurrencyInput(this); updateTotalStartingCapital()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="account-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <input type="text" id="account3Name" value="TFSA1" onchange="syncAccountNames()" style="width: 150px; margin-right: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </label>
                        <input type="text" id="account3Value" value="30,000" onchange="formatCurrencyInput(this); updateTotalStartingCapital()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="account-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <input type="text" id="account4Name" value="TFSA2" onchange="syncAccountNames()" style="width: 150px; margin-right: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </label>
                        <input type="text" id="account4Value" value="20,000" onchange="formatCurrencyInput(this); updateTotalStartingCapital()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="account-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <input type="text" id="account5Name" value="Taxable Brokerage" onchange="syncAccountNames()" style="width: 150px; margin-right: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </label>
                        <input type="text" id="account5Value" value="10,000" onchange="formatCurrencyInput(this); updateTotalStartingCapital()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>
                    
                    <div class="account-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <input type="text" id="account6Name" value="Smith" onchange="syncAccountNames()" style="width: 150px; margin-right: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        </label>
                        <input type="text" id="account6Value" value="0" onchange="formatCurrencyInput(this); updateTotalStartingCapital()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>
                </div>
            </div>
            
            <!-- 5. Annual Contributions -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="annualContributions">Annual Contributions ($)</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">Some general rules: 1) Prioritize paying down high interest debt (a loan with an interest rate greater than the value you inputted in Rate of Return). 2) During high income earning years, maximize contributions to RRSP accounts to lower your average tax rates (which in turn will give you a larger tax refund cheque). 3) Focus on building TFSA accounts during lower income years or when you may require more flexiibility in terms of capital liquidity (you can buy ETFs in your TFSA as well as other stocks and investments). 4) Non-registered aka Taxable Brokerage accounts can be another good option for building wealth once registered accounts are either fully/partially utilized, depending on the situation.</span>
                    </div>
                </div>
                <input type="text" id="annualContributions" value="71,000" readonly>
                
                <!-- Contributions Details Section (showing by default) -->
                <div id="contributionsDetailsSection" style="display: block; margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                    <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px; font-weight: 500;">Contributions by Account</h4>
                    
                    <div class="contribution-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <span id="contrib1NameLabel" style="display: inline-block; width: 150px; margin-right: 5px; padding: 8px; background: #f8f9fa; border: 1px solid #3a3a5a; border-radius: 6px; font-size: 14px; font-weight: 400; font-family: inherit; color: #6c757d; box-sizing: border-box; line-height: normal;">RRSP1</span>
                        </label>
                        <input type="text" id="contrib1Value" value="30,000" onchange="formatCurrencyInput(this); updateTotalContributions()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="contribution-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <span id="contrib2NameLabel" style="display: inline-block; width: 150px; margin-right: 5px; padding: 8px; background: #f8f9fa; border: 1px solid #3a3a5a; border-radius: 6px; font-size: 14px; font-weight: 400; font-family: inherit; color: #6c757d; box-sizing: border-box; line-height: normal;">RRSP2</span>
                        </label>
                        <input type="text" id="contrib2Value" value="20,000" onchange="formatCurrencyInput(this); updateTotalContributions()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="contribution-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <span id="contrib3NameLabel" style="display: inline-block; width: 150px; margin-right: 5px; padding: 8px; background: #f8f9fa; border: 1px solid #3a3a5a; border-radius: 6px; font-size: 14px; font-weight: 400; font-family: inherit; color: #6c757d; box-sizing: border-box; line-height: normal;">TFSA1</span>
                        </label>
                        <input type="text" id="contrib3Value" value="10,000" onchange="formatCurrencyInput(this); updateTotalContributions()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="contribution-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <span id="contrib4NameLabel" style="display: inline-block; width: 150px; margin-right: 5px; padding: 8px; background: #f8f9fa; border: 1px solid #3a3a5a; border-radius: 6px; font-size: 14px; font-weight: 400; font-family: inherit; color: #6c757d; box-sizing: border-box; line-height: normal;">TFSA2</span>
                        </label>
                        <input type="text" id="contrib4Value" value="10,000" onchange="formatCurrencyInput(this); updateTotalContributions()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="contribution-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <span id="contrib5NameLabel" style="display: inline-block; width: 150px; margin-right: 5px; padding: 8px; background: #f8f9fa; border: 1px solid #3a3a5a; border-radius: 6px; font-size: 14px; font-weight: 400; font-family: inherit; color: #6c757d; box-sizing: border-box; line-height: normal;">Taxable Brokerage</span>
                        </label>
                        <input type="text" id="contrib5Value" value="1,000" onchange="formatCurrencyInput(this); updateTotalContributions()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>

                    <div class="contribution-item" style="margin-bottom: 15px;">
                        <label style="display: inline-block; width: 140px; font-size: 14px; color: #555; margin-right: 10px;">
                            <span id="contrib6NameLabel" style="display: inline-block; width: 150px; margin-right: 5px; padding: 8px; background: #f8f9fa; border: 1px solid #3a3a5a; border-radius: 6px; font-size: 14px; font-weight: 400; font-family: inherit; color: #6c757d; box-sizing: border-box; line-height: normal;">Other</span>
                        </label>
                        <input type="text" id="contrib6Value" value="0" onchange="formatCurrencyInput(this); updateTotalContributions()" style="width: 97px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                    </div>
                </div>
            </div>
            
            
            <!-- 6. Annual Active Spending -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="activeSpending">Annual Active Spending ($)</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">What expenses do you want to have covered by your portfolio? As an example, you could take your current annual budget and exclude your mortgage payment (if you plan to have that paid off beforehand) or include rent if you don't plan on owning your primary residence, exclude kids activities, exclude RESP contributions, adjust travel spending, etc.</span>
                    </div>
                </div>
                <input type="text" id="activeSpending" value="70,000">
            </div>
            
            <!-- 7. Annual Inactive Spending -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="inactiveSpending">Annual Inactive Spending ($)</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">Typically, people spend more money in the years they are more physically capable eg. travel more, go out for food/entertainment, take on expensive hobbies like skiing, pouring money into the latest fads like Labubus, etc. relative to when they hit their more inactive years later in life. How much do you think you'd spend in your less active years? When in doubt, you can try using 80% of your Annual Active Spending estimate.</span>
                    </div>
                </div>
                <input type="text" id="inactiveSpending" value="60,000">
            </div>
            
            <!-- 8. Rate of Return -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="rateOfReturn">Rate of Return (%)</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">The average annual return of the S&P 500 over the past century is generally cited as being around 10% (ticker codes: VFV.TO, TPU.TO are examples of low cost S&P500 Index ETFs available for puchase in Canadian dollars at most Canadian brokerages and banks.). When limited to non-ETF investment options, say within your company's group retirement plan, aim for funds with MER (Management Expense Ratios) that are 0.6% or lower.</span>
                    </div>
                </div>
                <input type="number" id="rateOfReturn" value="7" step="0.1">
            </div>
            
            <!-- 9. Inflation Rate -->
            <div class="input-group">
                <label for="inflationRate">Inflation Rate (%)</label>
                <input type="number" id="inflationRate" value="2.5" step="0.1">
            </div>
            
            <!-- 10. Withdrawal Rate -->
            <div class="input-group">
                <div class="label-with-tooltip">
                    <label for="withdrawalRate">Withdrawal Rate (%)</label>
                    <div class="tooltip-container">
                        <span class="info-icon">i</span>
                        <span class="tooltip-text">The 4% rule is a guideline for retirement withdrawals, suggesting you can withdraw 4% of your initial investment portfolio in your first year of retirement, then adjust the dollar amount for inflation in subsequent years, with a high probability of your money lasting 30 years or more. Developed from Bill Bengen's 1990s research using historical market data, it serves as a starting point for planning retirement income, though it has limitations and newer research suggests potentially different withdrawal rates are necessary for modern retirement conditions. - Google Gemini.</span>
                    </div>
                </div>
                <input type="number" id="withdrawalRate" value="4" step="0.1">
            </div>
        </div>
        
        <div class="debt-section">
            <div class="debt-header">
                <button type="button" class="debt-toggle-btn expanded" onclick="toggleDebtSection()">
                    <span class="toggle-icon">▼</span>
                    <span class="toggle-text">Hide Debt Tracking</span>
                </button>
            </div>
            <div class="debt-content show" id="debtContent">
                <div class="debt-grid">
                <div class="debt-item">
                    <h3>Mortgage</h3>
                    <div class="debt-inputs">
                        <div class="input-group">
                            <label for="mortgageBalance">Outstanding Balance ($)</label>
                            <input type="text" id="mortgageBalance" value="500,000">
                        </div>
                        <div class="input-group">
                            <label for="mortgageRate">Interest Rate (%)</label>
                            <input type="number" id="mortgageRate" value="4.7" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="mortgagePayment">Total Monthly Payment ($)</label>
                            <input type="text" id="mortgagePayment" value="2,000">
                        </div>
                        <div class="input-group">
                            <label for="mortgageExtraPayment">Additional Monthly Principal Payment ($)</label>
                            <input type="text" id="mortgageExtraPayment" value="0">
                        </div>
                        <div class="input-group">
                            <div class="label-with-tooltip">
                                <label for="mortgageAffectContributions">Affect Annual Contributions</label>
                                <div class="tooltip-container">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Selecting "Yes" here assumes that your annual contributions will be reduced by your debt payments. "No" means that you will still be able to contribute the target annual contributions set above even while paying off this loan.</span>
                                </div>
                            </div>
                            <select id="mortgageAffectContributions">
                                <option value="yes">Yes</option>
                                <option value="no" selected>No</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="debt-item">
                    <h3>Vehicle Loan</h3>
                    <div class="debt-inputs">
                        <div class="input-group">
                            <label for="vehicleBalance">Outstanding Balance ($)</label>
                            <input type="text" id="vehicleBalance" value="0">
                        </div>
                        <div class="input-group">
                            <label for="vehicleRate">Interest Rate (%)</label>
                            <input type="number" id="vehicleRate" value="0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="vehiclePayment">Total Monthly Payment ($)</label>
                            <input type="text" id="vehiclePayment" value="0">
                        </div>
                        <div class="input-group">
                            <label for="vehicleExtraPayment">Additional Monthly Principal Payment ($)</label>
                            <input type="text" id="vehicleExtraPayment" value="0">
                        </div>
                        <div class="input-group">
                            <div class="label-with-tooltip">
                                <label for="vehicleAffectContributions">Affect Annual Contributions</label>
                                <div class="tooltip-container">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Selecting "Yes" here assumes that your annual contributions will be reduced by your debt payments. "No" means that you will still be able to contribute the target annual contributions set above even while paying off this loan.</span>
                                </div>
                            </div>
                            <select id="vehicleAffectContributions">
                                <option value="yes">Yes</option>
                                <option value="no" selected>No</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="debt-item">
                    <h3>Other</h3>
                    <div class="debt-inputs">
                        <div class="input-group">
                            <label for="otherBalance">Outstanding Balance ($)</label>
                            <input type="text" id="otherBalance" value="0">
                        </div>
                        <div class="input-group">
                            <label for="otherRate">Interest Rate (%)</label>
                            <input type="number" id="otherRate" value="0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="otherPayment">Total Monthly Payment ($)</label>
                            <input type="text" id="otherPayment" value="0">
                        </div>
                        <div class="input-group">
                            <label for="otherExtraPayment">Additional Monthly Principal Payment ($)</label>
                            <input type="text" id="otherExtraPayment" value="0">
                        </div>
                        <div class="input-group">
                            <div class="label-with-tooltip">
                                <label for="otherAffectContributions">Affect Annual Contributions</label>
                                <div class="tooltip-container">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Selecting "Yes" here assumes that your annual contributions will be reduced by your debt payments. "No" means that you will still be able to contribute the target annual contributions set above even while paying off this loan.</span>
                                </div>
                            </div>
                            <select id="otherAffectContributions">
                                <option value="yes">Yes</option>
                                <option value="no" selected>No</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
        
        <div class="scenario-controls">
            <div class="input-group">
                <label for="scenarioName" style="font-size: 18px;">Scenario Name</label>
                <input type="text" id="scenarioName" placeholder="Enter scenario name..." maxlength="30">
            </div>
            <div class="control-buttons">
                <button class="calculate-btn" onclick="calculateFI()">Calculate Financial Independence</button>
                <button class="clear-btn" onclick="clearScenarios()">Clear Scenarios</button>
            </div>
            
            <!-- Scenario Selection for App Progression -->
            <div id="scenarioSelection" class="scenario-selection" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #D3AF37; border-radius: 8px; background-color: #f1f8e9;">
                <h4 style="margin: 0 0 15px 0; color: #8B6914;">Ready to Continue Your FI Journey?</h4>
                <p style="margin: 0 0 15px 0; color: #555;">Select one of your calculated scenarios to proceed with net worth tracking, budgeting, and other FI Quest features:</p>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="progressScenarioSelect" style="flex: 1; padding: 15px; border: 1px solid #D3AF37; border-radius: 6px; font-size: 16px; font-weight: 400; font-family: inherit;">
                        <option value="">Choose a scenario to continue with...</option>
                    </select>
                    <button onclick="proceedWithSelectedScenario()" style="padding: 15px 30px; background-color: #D3AF37; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 16px; font-family: inherit;">Continue Journey →</button>
                </div>
            </div>
        </div>
        
        <div id="results" class="results-section">
            <div class="key-results">
                <div class="result-card">
                    <h3>Financial Independence Year</h3>
                    <div class="value" id="fiYear">-</div>
                </div>
                <div class="result-card">
                    <h3>Final Portfolio Value</h3>
                    <div class="value" id="finalValue">-</div>
                </div>
                <div class="result-card">
                    <h3>Monthly Savings Required</h3>
                    <div class="value" id="monthlySavings">-</div>
                </div>
            </div>
            
            <h3>Portfolio Value Over Time</h3>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
            
            <h3>Annual Spending vs Withdrawal Capacity</h3>
            <div class="chart-container">
                <canvas id="spendingChart"></canvas>
            </div>
            
            <div id="debtChartSection" style="display: none;">
                <h3>Remaining Debt Balances</h3>
                <div class="chart-container">
                    <canvas id="debtChart"></canvas>
                </div>
            </div>
            
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Age</th>
                            <th>Portfolio Value</th>
                            <th>Annual Spending</th>
                            <th>Withdrawal Capacity</th>
                            <th>Net Contributions</th>
                            <th>Remaining Debt</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="disclaimer">
        <h3>Disclaimer</h3>
        <p>This material is provided for general informational purposes only and does not constitute financial, investment, tax, legal or accounting advice, it should not be relied upon in that regard or be considered predictive of any future market performance, nor does it constitute an offer or solicitation to buy or sell any securities referred to. Individual circumstances and current events are critical to sound investment planning; anyone wishing to act on this material should consult with their advisor. Before making any investment decisions, we encourage you to consider these and other factors carefully. Past performance may not be repeated and is not indicative of future results.</p>
    </div>

    <script>
        // Touch device detection and tooltip functionality
        function isTouchDevice() {
            return ('ontouchstart' in window) || 
                   (navigator.maxTouchPoints > 0) || 
                   (navigator.msMaxTouchPoints > 0);
        }

        // Initialize touch-friendly tooltips
        function initializeTouchTooltips() {
            const isTouch = isTouchDevice();
            const tooltipContainers = document.querySelectorAll('.tooltip-container');
            
            if (isTouch) {
                // Add touch-specific styles
                const style = document.createElement('style');
                style.textContent = `
                    .tooltip-container:hover .tooltip-text {
                        visibility: hidden;
                        opacity: 0;
                    }
                    .tooltip-container.active .tooltip-text {
                        visibility: visible;
                        opacity: 1;
                    }
                    .info-icon {
                        user-select: none;
                        -webkit-user-select: none;
                        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
                    }
                `;
                document.head.appendChild(style);
                
                tooltipContainers.forEach(container => {
                    const infoIcon = container.querySelector('.info-icon');
                    if (infoIcon) {
                        // Handle tap events for touch devices
                        infoIcon.addEventListener('touchstart', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Close all other tooltips
                            tooltipContainers.forEach(otherContainer => {
                                if (otherContainer !== container) {
                                    otherContainer.classList.remove('active');
                                }
                            });
                            
                            // Toggle current tooltip
                            container.classList.toggle('active');
                        }, { passive: false });
                        
                        // Handle click events as fallback
                        infoIcon.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Close all other tooltips
                            tooltipContainers.forEach(otherContainer => {
                                if (otherContainer !== container) {
                                    otherContainer.classList.remove('active');
                                }
                            });
                            
                            // Toggle current tooltip
                            container.classList.toggle('active');
                        });
                    }
                });
                
                // Close tooltips when tapping elsewhere
                document.addEventListener('touchstart', function(e) {
                    if (!e.target.closest('.tooltip-container')) {
                        tooltipContainers.forEach(container => {
                            container.classList.remove('active');
                        });
                    }
                });
                
                // Close tooltips when clicking elsewhere (fallback)
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.tooltip-container')) {
                        tooltipContainers.forEach(container => {
                            container.classList.remove('active');
                        });
                    }
                });
            } else {
                // Desktop: ensure hover functionality works
                tooltipContainers.forEach(container => {
                    const infoIcon = container.querySelector('.info-icon');
                    if (infoIcon) {
                        // Optional: Add click functionality for desktop too
                        infoIcon.addEventListener('click', function(e) {
                            e.preventDefault();
                            container.classList.toggle('active');
                        });
                    }
                });
            }
        }

        // Toggle debt section visibility
        function toggleDebtSection() {
            const debtContent = document.getElementById('debtContent');
            const toggleBtn = document.querySelector('.debt-toggle-btn');
            const toggleText = document.querySelector('.toggle-text');
            const isVisible = debtContent.classList.contains('show');
            
            if (isVisible) {
                // Hide debt section
                debtContent.classList.remove('show');
                toggleBtn.classList.remove('expanded');
                toggleText.textContent = 'Show Debt Tracking';
            } else {
                // Show debt section
                debtContent.classList.add('show');
                toggleBtn.classList.add('expanded');
                toggleText.textContent = 'Hide Debt Tracking';
            }
        }

        // Initialize tooltips when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeTouchTooltips);

        let portfolioChartInstance = null;
        let spendingChartInstance = null;
        let debtChartInstance = null;
        
        let scenarios = [];
        const scenarioColors = ['#D3AF37', '#2196F3', '#FF9800'];
        
        // Load saved scenarios from user data
        function loadSavedScenarios() {
            try {
                console.log('=== loadSavedScenarios Debug ===');
                const savedScenarios = localStorage.getItem('fiquest_scenarios');
                console.log('Raw localStorage fiquest_scenarios:', savedScenarios);
                
                if (savedScenarios) {
                    scenarios = JSON.parse(savedScenarios);
                    console.log(`Loaded ${scenarios.length} saved scenarios:`, scenarios);
                    
                    // Update UI if scenarios exist
                    if (scenarios.length > 0) {
                        console.log('Displaying scenarios and updating UI');
                        displayAllScenarios();
                        updateScenarioSelectionUI();
                    } else {
                        console.log('No scenarios to display');
                    }
                } else {
                    console.log('No saved scenarios found in localStorage');
                    scenarios = [];
                }
                console.log('=== End loadSavedScenarios Debug ===');
            } catch (error) {
                console.error('Error loading saved scenarios:', error);
                scenarios = [];
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function calculateMonthsRemaining(balance, rate, payment, extraPayment = 0) {
            if (balance <= 0 || payment <= 0) return 0;
            
            const totalPayment = payment + extraPayment;
            
            if (rate <= 0) return Math.ceil(balance / totalPayment);
            
            const monthlyRate = rate / 12;
            const monthlyInterest = balance * monthlyRate;
            
            if (totalPayment <= monthlyInterest) return Infinity; // Payment doesn't cover interest
            
            return Math.ceil(-Math.log(1 - (balance * monthlyRate) / totalPayment) / Math.log(1 + monthlyRate));
        }
        
        // Number formatting functions
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        function unformatNumber(str) {
            return parseFloat(str.toString().replace(/,/g, '')) || 0;
        }
        
        function formatCurrencyInput(inputElement) {
            const value = unformatNumber(inputElement.value);
            inputElement.value = formatNumber(value);
        }
        
        // Account management functions
        function toggleAccountView() {
            const detailsSection = document.getElementById('accountDetailsSection');
            const contributionsSection = document.getElementById('contributionsDetailsSection');
            const toggleBtn = document.getElementById('toggleAccountDetails');
            const isVisible = detailsSection.style.display === 'block';
            
            if (isVisible) {
                // Hide both sections
                detailsSection.style.display = 'none';
                contributionsSection.style.display = 'none';
                toggleBtn.textContent = 'Show Account Details';
            } else {
                // Show both sections
                detailsSection.style.display = 'block';
                contributionsSection.style.display = 'block';
                toggleBtn.textContent = 'Hide Account Details';
            }
        }
        
        function updateTotalStartingCapital() {
            let total = 0;
            for (let i = 1; i <= 6; i++) {
                const accountElement = document.getElementById(`account${i}Value`);
                const accountValue = unformatNumber(accountElement.value);
                total += accountValue;
            }
            document.getElementById('startingCapital').value = formatNumber(total);
        }
        
        function updateTotalContributions() {
            let total = 0;
            for (let i = 1; i <= 6; i++) {
                const contribElement = document.getElementById(`contrib${i}Value`);
                const contribValue = unformatNumber(contribElement.value);
                total += contribValue;
            }
            document.getElementById('annualContributions').value = formatNumber(total);
        }
        
        function syncAccountNames() {
            // Sync account names from starting capital to contributions labels
            for (let i = 1; i <= 6; i++) {
                const accountNameInput = document.getElementById(`account${i}Name`);
                const contribNameLabel = document.getElementById(`contrib${i}NameLabel`);
                if (accountNameInput && contribNameLabel) {
                    contribNameLabel.textContent = accountNameInput.value;
                }
            }
        }
        
        // Load scenario defaults from active scenario
        function loadScenarioDefaults() {
            try {
                const userData = userManager.getCurrentPlayerData();
                if (userData && userData.gameData && userData.gameData.activeScenario) {
                    const scenario = userData.gameData.activeScenario;
                    
                    // Load basic info
                    if (scenario.currentAge) document.getElementById('currentAge').value = scenario.currentAge;
                    if (scenario.lifeExpectancy) document.getElementById('lifeExpectancy').value = scenario.lifeExpectancy;
                    if (scenario.activeUntilAge) document.getElementById('activeUntilAge').value = scenario.activeUntilAge;
                    
                    // Load spending amounts
                    if (scenario.activeSpending) document.getElementById('activeSpending').value = formatNumber(scenario.activeSpending);
                    if (scenario.inactiveSpending) document.getElementById('inactiveSpending').value = formatNumber(scenario.inactiveSpending);
                    
                    // Load rates
                    if (scenario.rateOfReturn) document.getElementById('rateOfReturn').value = (scenario.rateOfReturn * 100).toFixed(1);
                    if (scenario.inflationRate) document.getElementById('inflationRate').value = (scenario.inflationRate * 100).toFixed(1);
                    if (scenario.withdrawalRate) document.getElementById('withdrawalRate').value = (scenario.withdrawalRate * 100).toFixed(1);
                    
                    // Load investment accounts
                    if (scenario.accounts && Array.isArray(scenario.accounts)) {
                        for (let i = 0; i < Math.min(scenario.accounts.length, 6); i++) {
                            const account = scenario.accounts[i];
                            const accountNum = i + 1;
                            document.getElementById(`account${accountNum}Name`).value = account.name || '';
                            document.getElementById(`account${accountNum}Value`).value = formatNumber(account.value || 0);
                        }
                        // Clear unused account fields
                        for (let i = scenario.accounts.length; i < 6; i++) {
                            const accountNum = i + 1;
                            document.getElementById(`account${accountNum}Name`).value = '';
                            document.getElementById(`account${accountNum}Value`).value = '0';
                        }
                    }
                    
                    // Load contribution amounts (match accounts)
                    if (scenario.accounts && Array.isArray(scenario.accounts)) {
                        for (let i = 0; i < Math.min(scenario.accounts.length, 6); i++) {
                            const accountNum = i + 1;
                            // Set contribution to 0 by default, user can adjust
                            document.getElementById(`contrib${accountNum}Value`).value = '0';
                        }
                    }
                    
                    // Load debt information
                    if (scenario.debts) {
                        if (scenario.debts.mortgage) {
                            const mortgage = scenario.debts.mortgage;
                            document.getElementById('mortgageBalance').value = formatNumber(mortgage.balance || 0);
                            document.getElementById('mortgageRate').value = ((mortgage.rate || 0) * 100).toFixed(2);
                            document.getElementById('mortgagePayment').value = formatNumber(mortgage.payment || 0);
                            document.getElementById('mortgageExtraPayment').value = formatNumber(mortgage.extraPayment || 0);
                            document.getElementById('mortgageAffectContributions').value = mortgage.affectContributions ? 'yes' : 'no';
                        }
                        
                        if (scenario.debts.vehicle) {
                            const vehicle = scenario.debts.vehicle;
                            document.getElementById('vehicleBalance').value = formatNumber(vehicle.balance || 0);
                            document.getElementById('vehicleRate').value = ((vehicle.rate || 0) * 100).toFixed(2);
                            document.getElementById('vehiclePayment').value = formatNumber(vehicle.payment || 0);
                            document.getElementById('vehicleExtraPayment').value = formatNumber(vehicle.extraPayment || 0);
                            document.getElementById('vehicleAffectContributions').value = vehicle.affectContributions ? 'yes' : 'no';
                        }
                        
                        if (scenario.debts.other) {
                            const other = scenario.debts.other;
                            document.getElementById('otherBalance').value = formatNumber(other.balance || 0);
                            document.getElementById('otherRate').value = ((other.rate || 0) * 100).toFixed(2);
                            document.getElementById('otherPayment').value = formatNumber(other.payment || 0);
                            document.getElementById('otherExtraPayment').value = formatNumber(other.extraPayment || 0);
                            document.getElementById('otherAffectContributions').value = other.affectContributions ? 'yes' : 'no';
                        }
                    }
                    
                    console.log('Loaded scenario defaults successfully');
                    return true;
                } else {
                    console.log('No active scenario found, using default values');
                    return false;
                }
            } catch (error) {
                console.error('Error loading scenario defaults:', error);
                return false;
            }
        }

        // Initialize calculator formatting
        function initializeCalculator() {
            // First try to load scenario defaults
            const scenarioLoaded = loadScenarioDefaults();
            
            // Format all currency inputs
            const currencyInputs = [
                'startingCapital', 'account1Value', 'account2Value', 'account3Value', 
                'account4Value', 'account5Value', 'account6Value', 'activeSpending', 
                'inactiveSpending', 'annualContributions', 'contrib1Value', 'contrib2Value',
                'contrib3Value', 'contrib4Value', 'contrib5Value', 'contrib6Value',
                'mortgageBalance', 'mortgagePayment', 'mortgageExtraPayment', 'vehicleBalance', 
                'vehiclePayment', 'vehicleExtraPayment', 'otherBalance', 
                'otherPayment', 'otherExtraPayment'
            ];
            
            currencyInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Format initial value
                    formatCurrencyInput(element);
                    
                    // Add blur event listener to format on exit
                    element.addEventListener('blur', function() {
                        formatCurrencyInput(this);
                        if (id.includes('account') && id.includes('Value')) {
                            updateTotalStartingCapital();
                        }
                        if (id.includes('contrib') && id.includes('Value')) {
                            updateTotalContributions();
                        }
                    });
                }
            });
            
            // Initialize totals and sync account names
            updateTotalStartingCapital();
            updateTotalContributions();
            syncAccountNames();
            
            if (scenarioLoaded) {
                console.log('FI Calculator initialized with scenario defaults');
            } else {
                console.log('FI Calculator initialized with default values');
            }
        }
        
        function calculateFI() {
            // Update totals from individual accounts
            updateTotalStartingCapital();
            updateTotalContributions();
            
            if (scenarios.length >= 3) {
                alert('Maximum of 3 scenarios allowed. Please clear scenarios to add more.');
                return;
            }
            
            let scenarioName = document.getElementById('scenarioName').value.trim();
            if (!scenarioName) {
                scenarioName = `Scenario ${scenarios.length + 1}`;
            }
            
            const inputs = {
                startingCapital: unformatNumber(document.getElementById('startingCapital').value),
                currentAge: parseInt(document.getElementById('currentAge').value),
                lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value),
                activeUntilAge: parseInt(document.getElementById('activeUntilAge').value),
                activeSpending: unformatNumber(document.getElementById('activeSpending').value),
                inactiveSpending: unformatNumber(document.getElementById('inactiveSpending').value),
                rateOfReturn: parseFloat(document.getElementById('rateOfReturn').value) / 100,
                annualContributions: unformatNumber(document.getElementById('annualContributions').value),
                inflationRate: parseFloat(document.getElementById('inflationRate').value) / 100,
                withdrawalRate: parseFloat(document.getElementById('withdrawalRate').value) / 100,
                accounts: [],
                debts: {
                    mortgage: {
                        balance: unformatNumber(document.getElementById('mortgageBalance').value),
                        rate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                        payment: unformatNumber(document.getElementById('mortgagePayment').value),
                        extraPayment: unformatNumber(document.getElementById('mortgageExtraPayment').value),
                        affectContributions: document.getElementById('mortgageAffectContributions').value === 'yes'
                    },
                    vehicle: {
                        balance: unformatNumber(document.getElementById('vehicleBalance').value),
                        rate: parseFloat(document.getElementById('vehicleRate').value) / 100,
                        payment: unformatNumber(document.getElementById('vehiclePayment').value),
                        extraPayment: unformatNumber(document.getElementById('vehicleExtraPayment').value),
                        affectContributions: document.getElementById('vehicleAffectContributions').value === 'yes'
                    },
                    other: {
                        balance: unformatNumber(document.getElementById('otherBalance').value),
                        rate: parseFloat(document.getElementById('otherRate').value) / 100,
                        payment: unformatNumber(document.getElementById('otherPayment').value),
                        extraPayment: unformatNumber(document.getElementById('otherExtraPayment').value),
                        affectContributions: document.getElementById('otherAffectContributions').value === 'yes'
                    }
                }
            };
            
            // Capture individual account details
            for (let i = 1; i <= 6; i++) {
                const accountName = document.getElementById(`account${i}Name`).value;
                const accountValue = unformatNumber(document.getElementById(`account${i}Value`).value);
                if (accountName && accountValue > 0) {
                    inputs.accounts.push({
                        name: accountName,
                        value: accountValue
                    });
                }
            }
            
            const results = performCalculations(inputs);
            
            scenarios.push({
                name: scenarioName,
                inputs: inputs,
                results: results,
                color: scenarioColors[scenarios.length]
            });
            
            // Save scenarios to localStorage and user data
            localStorage.setItem('fiquest_scenarios', JSON.stringify(scenarios));
            userManager.savePlayerData();
            
            displayAllScenarios();
            updateScenarioSelectionUI();
            
            // Clear scenario name for next input
            document.getElementById('scenarioName').value = '';
        }
        
        function clearScenarios() {
            scenarios = [];
            localStorage.setItem('fiquest_scenarios', JSON.stringify(scenarios));
            userManager.savePlayerData();
            
            document.getElementById('results').style.display = 'none';
            document.getElementById('scenarioName').value = '';
            updateScenarioSelectionUI();
        }

        // Scenario Selection for App Progression
        function updateScenarioSelectionUI() {
            const select = document.getElementById('progressScenarioSelect');
            const selectionDiv = document.getElementById('scenarioSelection');
            
            // Clear existing options
            select.innerHTML = '<option value="">Choose a scenario to continue with...</option>';
            
            // Add current scenarios to dropdown
            scenarios.forEach((scenario, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = scenario.name;
                select.appendChild(option);
            });
            
            // Show/hide the selection UI based on whether we have scenarios
            if (scenarios.length > 0) {
                selectionDiv.style.display = 'block';
            } else {
                selectionDiv.style.display = 'none';
            }
        }
        
        function proceedWithSelectedScenario() {
            const select = document.getElementById('progressScenarioSelect');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') {
                alert('Please select a scenario to continue with.');
                return;
            }
            
            const selectedScenario = scenarios[parseInt(selectedIndex)];
            
            if (!selectedScenario) {
                alert('Selected scenario not found.');
                return;
            }
            
            // Store the selected scenario for use throughout the app
            localStorage.setItem('fiquest_active_scenario', JSON.stringify(selectedScenario));
            
            // Save to user data immediately
            userManager.savePlayerData();
            
            // Show success message and redirect to next section
            alert(`Great! You've selected "${selectedScenario.name}" as your FI plan. You can now proceed to set up net worth tracking, budgeting, and other features.`);
            
            // Navigate to the next logical section (net worth tracking)
            window.location.href = 'net-worth.html';
        }

        // Net Worth Setup Functions
        let assetAllocationChart = null;

        function initializeNetWorthPage() {
            const activeScenario = JSON.parse(localStorage.getItem('fiquest_active_scenario') || 'null');
            
            if (activeScenario) {
                // Display selected scenario info
                document.getElementById('scenarioNameDisplay').textContent = activeScenario.name;
                
                // Populate investment accounts from scenario
                populateInvestmentAccounts(activeScenario);
                
                // Populate scenario debts
                populateScenarioDebts(activeScenario);
            } else {
                // No scenario selected - show default/empty state for testing
                document.getElementById('scenarioNameDisplay').textContent = 'No Scenario Selected (Demo Mode)';
                
                // Populate with demo/default investment accounts
                populateDefaultInvestmentAccounts();
                
                // Populate with demo/default debts
                populateDefaultScenarioDebts();
            }
            
            // Load saved net worth data if available
            loadSavedNetWorthSetup();
            
            // Initialize currency formatting for default values
            initializeNetWorthInputs();
            
            // Update calculations
            updateNetWorth();
        }

        function populateInvestmentAccounts(scenario) {
            const accountsList = document.getElementById('investmentAccountsList');
            let totalInvestment = 0;
            
            accountsList.innerHTML = '';
            
            // Get account names and values from current DOM (since scenario was just calculated)
            for (let i = 1; i <= 6; i++) {
                const accountNameElement = document.getElementById(`account${i}Name`);
                const accountValueElement = document.getElementById(`account${i}Value`);
                
                if (accountNameElement && accountValueElement) {
                    const accountName = accountNameElement.value;
                    const accountValue = unformatNumber(accountValueElement.value);
                    
                    if (accountName && accountValue > 0) {
                        const accountDiv = document.createElement('div');
                        accountDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = accountName;
                        nameSpan.style.color = '#666';
                        
                        const valueSpan = document.createElement('span');
                        valueSpan.textContent = '$' + formatNumber(accountValue);
                        valueSpan.style.fontWeight = 'bold';
                        
                        accountDiv.appendChild(nameSpan);
                        accountDiv.appendChild(valueSpan);
                        accountsList.appendChild(accountDiv);
                        
                        totalInvestment += accountValue;
                    }
                }
            }
            
            document.getElementById('totalInvestmentAccounts').value = '$' + formatNumber(totalInvestment);
        }

        function populateScenarioDebts(scenario) {
            const debtsList = document.getElementById('scenarioDebtsList');
            let totalDebt = 0;
            
            debtsList.innerHTML = '';
            
            // Check mortgage from DOM
            const mortgageBalance = unformatNumber(document.getElementById('mortgageBalance').value);
            if (mortgageBalance > 0) {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Mortgage';
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(mortgageBalance);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += mortgageBalance;
            }
            
            // Check vehicle loan from DOM
            const vehicleBalance = unformatNumber(document.getElementById('vehicleBalance').value);
            if (vehicleBalance > 0) {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Vehicle Loan';
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(vehicleBalance);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += vehicleBalance;
            }
            
            // Check other debt from DOM
            const otherBalance = unformatNumber(document.getElementById('otherBalance').value);
            if (otherBalance > 0) {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Other Debt';
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(otherBalance);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += otherBalance;
            }
            
            document.getElementById('totalScenarioDebts').value = '$' + formatNumber(totalDebt);
        }

        function populateDefaultInvestmentAccounts() {
            const accountsList = document.getElementById('investmentAccountsList');
            let totalInvestment = 0;
            
            accountsList.innerHTML = '';
            
            // Default demo investment accounts for testing
            const defaultAccounts = [
                { name: 'RRSP1', value: 250000 },
                { name: 'RRSP2', value: 150000 },
                { name: 'TFSA1', value: 300000 },
                { name: 'TFSA2', value: 200000 },
                { name: 'Taxable Brokerage', value: 100000 }
            ];
            
            defaultAccounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = account.name;
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(account.value);
                valueSpan.style.fontWeight = 'bold';
                
                accountDiv.appendChild(nameSpan);
                accountDiv.appendChild(valueSpan);
                accountsList.appendChild(accountDiv);
                
                totalInvestment += account.value;
            });
            
            document.getElementById('totalInvestmentAccounts').value = '$' + formatNumber(totalInvestment);
        }

        function populateDefaultScenarioDebts() {
            const debtsList = document.getElementById('scenarioDebtsList');
            let totalDebt = 0;
            
            debtsList.innerHTML = '';
            
            // Default demo debts for testing
            const defaultDebts = [
                { name: 'Mortgage', value: 800000 },
                { name: 'Vehicle Loan', value: 25000 },
                { name: 'Other Debt', value: 15000 }
            ];
            
            defaultDebts.forEach(debt => {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = debt.name;
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(debt.value);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += debt.value;
            });
            
            document.getElementById('totalScenarioDebts').value = '$' + formatNumber(totalDebt);
        }

        function initializeNetWorthInputs() {
            // Format currency inputs for additional assets
            const assetInputs = ['asset1Value', 'asset2Value', 'asset3Value', 'asset4Value', 'asset5Value'];
            assetInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    formatCurrencyInput(element);
                }
            });
            
            // Format currency inputs for additional liabilities
            const liabilityInputs = ['liability1Value', 'liability2Value'];
            liabilityInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    formatCurrencyInput(element);
                }
            });
        }

        function updateNetWorth() {
            // Calculate total assets
            let totalAssets = 0;
            
            // Add investment accounts total
            const investmentTotal = unformatNumber(document.getElementById('totalInvestmentAccounts').value.replace('$', ''));
            totalAssets += investmentTotal;
            
            // Add additional assets
            for (let i = 1; i <= 5; i++) {
                const assetValue = unformatNumber(document.getElementById(`asset${i}Value`).value);
                totalAssets += assetValue;
            }
            
            // Calculate total liabilities
            let totalLiabilities = 0;
            
            // Add scenario debts total
            const scenarioDebtsTotal = unformatNumber(document.getElementById('totalScenarioDebts').value.replace('$', ''));
            totalLiabilities += scenarioDebtsTotal;
            
            // Add additional liabilities
            for (let i = 1; i <= 2; i++) {
                const liabilityValue = unformatNumber(document.getElementById(`liability${i}Value`).value);
                totalLiabilities += liabilityValue;
            }
            
            // Update displays (now using .value instead of .textContent)
            document.getElementById('totalAssets').value = '$' + formatNumber(totalAssets);
            document.getElementById('totalLiabilities').value = '$' + formatNumber(totalLiabilities);
            
            const netWorth = totalAssets - totalLiabilities;
            document.getElementById('currentNetWorth').value = '$' + formatNumber(netWorth);
            
            // Update asset allocation chart
            updateAssetAllocationChart(totalAssets);
        }

        function updateAssetAllocationChart(totalAssets) {
            const ctx = document.getElementById('assetAllocationChart').getContext('2d');
            
            if (assetAllocationChart) {
                assetAllocationChart.destroy();
            }
            
            // Gather data for chart
            const data = [];
            const labels = [];
            const colors = ['#D3AF37', '#2196F3', '#FF9800', '#9C27B0', '#607D8B', '#795548', '#E91E63', '#00BCD4'];
            
            // Investment accounts (combined as "Stocks")
            const investmentTotal = unformatNumber(document.getElementById('totalInvestmentAccounts').value.replace('$', ''));
            if (investmentTotal > 0) {
                data.push(((investmentTotal / totalAssets) * 100).toFixed(1));
                labels.push('Stocks');
            }
            
            // Additional assets
            for (let i = 1; i <= 5; i++) {
                const assetValue = unformatNumber(document.getElementById(`asset${i}Value`).value);
                const assetName = document.getElementById(`asset${i}Name`).value;
                
                if (assetValue > 0) {
                    data.push(((assetValue / totalAssets) * 100).toFixed(1));
                    labels.push(assetName);
                }
            }
            
            assetAllocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadSavedNetWorthSetup() {
            try {
                const savedData = localStorage.getItem('fiquest_net_worth_setup');
                if (savedData) {
                    const netWorthData = JSON.parse(savedData);
                    console.log('Loading saved net worth data:', netWorthData);
                    
                    // Load additional assets
                    if (netWorthData.assets && netWorthData.assets.additionalAssets) {
                        let assetIndex = 1;
                        Object.entries(netWorthData.assets.additionalAssets).forEach(([name, value]) => {
                            if (assetIndex <= 5) {
                                const nameElement = document.getElementById(`asset${assetIndex}Name`);
                                const valueElement = document.getElementById(`asset${assetIndex}Value`);
                                if (nameElement && valueElement) {
                                    nameElement.value = name;
                                    valueElement.value = formatNumber(value);
                                }
                                assetIndex++;
                            }
                        });
                    }
                    
                    // Load additional liabilities
                    if (netWorthData.liabilities && netWorthData.liabilities.additionalLiabilities) {
                        let liabilityIndex = 1;
                        Object.entries(netWorthData.liabilities.additionalLiabilities).forEach(([name, value]) => {
                            if (liabilityIndex <= 2) {
                                const nameElement = document.getElementById(`liability${liabilityIndex}Name`);
                                const valueElement = document.getElementById(`liability${liabilityIndex}Value`);
                                if (nameElement && valueElement) {
                                    nameElement.value = name;
                                    valueElement.value = formatNumber(value);
                                }
                                liabilityIndex++;
                            }
                        });
                    }
                    
                    console.log('Successfully loaded saved net worth setup');
                    return true;
                }
            } catch (error) {
                console.error('Error loading saved net worth setup:', error);
            }
            return false;
        }

        function saveNetWorthSetup() {
            try {
                const netWorthData = {
                    timestamp: new Date().toISOString(),
                    scenario: JSON.parse(localStorage.getItem('fiquest_active_scenario')),
                    assets: {
                        investmentAccounts: {
                            total: unformatNumber(document.getElementById('totalInvestmentAccounts').value),
                            details: []
                        },
                        additionalAssets: {},
                        totalAssets: unformatNumber(document.getElementById('totalAssets').value)
                    },
                    liabilities: {
                        scenarioDebts: {
                            total: unformatNumber(document.getElementById('totalScenarioDebts').value),
                            details: []
                        },
                        additionalLiabilities: {},
                        totalLiabilities: unformatNumber(document.getElementById('totalLiabilities').value)
                    },
                    netWorth: unformatNumber(document.getElementById('currentNetWorth').value)
                };
                
                // Capture investment accounts details
                const investmentAccountsListElement = document.getElementById('investmentAccountsList');
                if (investmentAccountsListElement) {
                    const accountItems = investmentAccountsListElement.querySelectorAll('.account-item');
                    accountItems.forEach(item => {
                        const nameSpan = item.querySelector('span:first-child');
                        const valueSpan = item.querySelector('span:last-child');
                        if (nameSpan && valueSpan) {
                            netWorthData.assets.investmentAccounts.details.push({
                                name: nameSpan.textContent,
                                value: unformatNumber(valueSpan.textContent)
                            });
                        }
                    });
                }
                
                // Capture scenario debts details
                const scenarioDebtsListElement = document.getElementById('scenarioDebtsList');
                if (scenarioDebtsListElement) {
                    const debtItems = scenarioDebtsListElement.querySelectorAll('.debt-item');
                    debtItems.forEach(item => {
                        const nameSpan = item.querySelector('span:first-child');
                        const valueSpan = item.querySelector('span:last-child');
                        if (nameSpan && valueSpan) {
                            netWorthData.liabilities.scenarioDebts.details.push({
                                name: nameSpan.textContent,
                                value: unformatNumber(valueSpan.textContent)
                            });
                        }
                    });
                }
                
                // Save additional assets
                for (let i = 1; i <= 5; i++) {
                    const assetNameElement = document.getElementById(`asset${i}Name`);
                    const assetValueElement = document.getElementById(`asset${i}Value`);
                    if (assetNameElement && assetValueElement) {
                        const assetName = assetNameElement.value.trim();
                        const assetValue = unformatNumber(assetValueElement.value);
                        if (assetName && assetValue > 0) {
                            netWorthData.assets.additionalAssets[assetName] = assetValue;
                        }
                    }
                }
                
                // Save additional liabilities
                for (let i = 1; i <= 2; i++) {
                    const liabilityNameElement = document.getElementById(`liability${i}Name`);
                    const liabilityValueElement = document.getElementById(`liability${i}Value`);
                    if (liabilityNameElement && liabilityValueElement) {
                        const liabilityName = liabilityNameElement.value.trim();
                        const liabilityValue = unformatNumber(liabilityValueElement.value);
                        if (liabilityName && liabilityValue > 0) {
                            netWorthData.liabilities.additionalLiabilities[liabilityName] = liabilityValue;
                        }
                    }
                }
                
                // Save to localStorage and user data
                localStorage.setItem('fiquest_net_worth_setup', JSON.stringify(netWorthData));
                userManager.savePlayerData();
                
                console.log('Net Worth Setup saved:', netWorthData);
                alert('Net worth setup saved successfully! All asset and liability data has been preserved.');
                
                return true;
            } catch (error) {
                console.error('Error saving net worth setup:', error);
                alert('Error saving net worth setup. Please check your data and try again.');
                return false;
            }
        }
        
        function performCalculations(inputs) {
            const years = [];
            let portfolioValue = inputs.startingCapital;
            let fiAchieved = false;
            let fiYear = null;
            let fiAge = null;
            let currentYear = new Date().getFullYear();
            
            // Initialize debt tracking with months remaining
            let debtBalances = {
                mortgage: inputs.debts.mortgage.balance,
                vehicle: inputs.debts.vehicle.balance,
                other: inputs.debts.other.balance
            };
            
            let debtMonths = {
                mortgage: calculateMonthsRemaining(inputs.debts.mortgage.balance, inputs.debts.mortgage.rate, inputs.debts.mortgage.payment, inputs.debts.mortgage.extraPayment),
                vehicle: calculateMonthsRemaining(inputs.debts.vehicle.balance, inputs.debts.vehicle.rate, inputs.debts.vehicle.payment, inputs.debts.vehicle.extraPayment),
                other: calculateMonthsRemaining(inputs.debts.other.balance, inputs.debts.other.rate, inputs.debts.other.payment, inputs.debts.other.extraPayment)
            };
            
            for (let year = 0; year <= inputs.lifeExpectancy - inputs.currentAge; year++) {
                const age = inputs.currentAge + year;
                const actualYear = currentYear + year;
                
                let baseSpending;
                if (age <= inputs.activeUntilAge) {
                    baseSpending = inputs.activeSpending * Math.pow(1 + inputs.inflationRate, year);
                } else {
                    baseSpending = inputs.inactiveSpending * Math.pow(1 + inputs.inflationRate, year);
                }
                
                // Calculate debt payments and remaining balances for this year
                let totalDebtPayments = 0;
                let debtPaymentsAffectingContributions = 0;
                let totalRemainingDebt = 0;
                const monthsElapsed = year * 12;
                
                Object.keys(debtBalances).forEach(debtType => {
                    const debt = inputs.debts[debtType];
                    const originalMonths = debtMonths[debtType];
                    
                    if (debtBalances[debtType] > 0 && monthsElapsed < originalMonths) {
                        // Still paying this debt
                        const totalMonthlyPayment = debt.payment + debt.extraPayment;
                        const annualPayment = totalMonthlyPayment * 12;
                        
                        totalDebtPayments += annualPayment;
                        
                        // Only count debt payments that affect contributions
                        if (debt.affectContributions) {
                            debtPaymentsAffectingContributions += annualPayment;
                        }
                        
                        // Calculate remaining balance using amortization formula
                        if (debt.rate > 0) {
                            const monthlyRate = debt.rate / 12;
                            const remainingMonths = Math.max(0, originalMonths - monthsElapsed);
                            const currentBalance = totalMonthlyPayment * ((1 - Math.pow(1 + monthlyRate, -remainingMonths)) / monthlyRate);
                            debtBalances[debtType] = Math.max(0, currentBalance);
                        } else {
                            // Simple interest or no interest
                            debtBalances[debtType] = Math.max(0, debt.balance - (totalMonthlyPayment * monthsElapsed));
                        }
                    } else {
                        // Debt is paid off
                        debtBalances[debtType] = 0;
                    }
                    
                    totalRemainingDebt += debtBalances[debtType];
                });

                // For FI achievement test, total spending need is the same regardless of contribution method
                const totalSpendingForFI = baseSpending + totalDebtPayments;
                const withdrawalCapacity = portfolioValue * inputs.withdrawalRate;
                
                if (!fiAchieved && withdrawalCapacity >= totalSpendingForFI) {
                    fiAchieved = true;
                    fiYear = actualYear;
                    fiAge = age;
                }
                
                // For actual withdrawal/spending tracking, debt payments that affect contributions
                // are handled differently - they don't need additional portfolio withdrawals
                const annualSpending = fiAchieved ? 
                    baseSpending + (totalDebtPayments - debtPaymentsAffectingContributions) :
                    totalSpendingForFI;
                
                // Store current year's data before applying growth
                const grossContributions = fiAchieved ? 0 : inputs.annualContributions;
                const netContributions = fiAchieved ? 0 : Math.max(0, grossContributions - debtPaymentsAffectingContributions);
                const status = fiAchieved ? 'Financial Independence Achieved' : 'Building';
                
                years.push({
                    year: actualYear,
                    age: age,
                    portfolioValue: portfolioValue,
                    annualSpending: annualSpending,
                    withdrawalCapacity: withdrawalCapacity,
                    contributions: netContributions,
                    totalRemainingDebt: totalRemainingDebt,
                    debtBreakdown: { ...debtBalances },
                    status: status,
                    isFiYear: !fiAchieved && withdrawalCapacity >= annualSpending
                });
                
                // Apply growth and changes for next year (except for the last iteration)
                if (year < inputs.lifeExpectancy - inputs.currentAge) {
                    if (fiAchieved) {
                        // Conservative approach: Apply withdrawals BEFORE growth
                        // First subtract annual spending from portfolio
                        portfolioValue -= annualSpending;
                        // Then apply growth to the remaining balance
                        const growthReturn = portfolioValue * inputs.rateOfReturn;
                        portfolioValue += growthReturn;
                    } else {
                        // Before FI, apply growth first then add net contributions
                        const growthReturn = portfolioValue * inputs.rateOfReturn;
                        portfolioValue += growthReturn + netContributions;
                    }
                }
            }
            
            const finalPortfolioValue = portfolioValue;
            const monthlySavingsRequired = inputs.annualContributions / 12;
            
            return {
                years: years,
                fiYear: fiYear,
                fiAge: fiAge,
                finalPortfolioValue: finalPortfolioValue,
                monthlySavingsRequired: monthlySavingsRequired
            };
        }
        
        function displayAllScenarios() {
            if (scenarios.length === 0) return;
            
            displayScenarioResults();
            createAllCharts();
            populateAllTables();
            
            document.getElementById('results').style.display = 'block';
        }
        
        function displayScenarioResults() {
            // Financial Independence Year
            let fiYearHTML = '';
            scenarios.forEach((scenario, index) => {
                const fiText = scenario.results.fiYear ? 
                    `${scenario.results.fiYear} (Age ${scenario.results.fiAge})` : 'Not Achieved';
                fiYearHTML += `<div class="scenario-result scenario-${index + 1}">
                    <strong>${scenario.name}:</strong> ${fiText}
                </div>`;
            });
            document.getElementById('fiYear').innerHTML = fiYearHTML;
            
            // Final Portfolio Value
            let finalValueHTML = '';
            scenarios.forEach((scenario, index) => {
                finalValueHTML += `<div class="scenario-result scenario-${index + 1}">
                    <strong>${scenario.name}:</strong> ${formatCurrency(scenario.results.finalPortfolioValue)}
                </div>`;
            });
            document.getElementById('finalValue').innerHTML = finalValueHTML;
            
            // Monthly Savings Required
            let monthlySavingsHTML = '';
            scenarios.forEach((scenario, index) => {
                monthlySavingsHTML += `<div class="scenario-result scenario-${index + 1}">
                    <strong>${scenario.name}:</strong> ${formatCurrency(scenario.results.monthlySavingsRequired)}
                </div>`;
            });
            document.getElementById('monthlySavings').innerHTML = monthlySavingsHTML;
        }
        
        function createAllCharts() {
            createPortfolioChart();
            createSpendingChart();
            createDebtChart();
        }
        
        function createPortfolioChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            if (portfolioChartInstance) {
                portfolioChartInstance.destroy();
            }
            
            const datasets = [];
            let allAges = [];
            
            scenarios.forEach((scenario, index) => {
                const ages = scenario.results.years.map(y => y.age);
                const portfolioValues = scenario.results.years.map(y => y.portfolioValue);
                
                if (index === 0) {
                    allAges = ages;
                }
                
                datasets.push({
                    label: scenario.name,
                    data: portfolioValues,
                    borderColor: scenario.color,
                    backgroundColor: scenario.color + '20',
                    fill: false,
                    tension: 0.1
                });
            });
            
            portfolioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allAges,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Portfolio Value ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createSpendingChart() {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            
            if (spendingChartInstance) {
                spendingChartInstance.destroy();
            }
            
            const datasets = [];
            let allAges = [];
            
            scenarios.forEach((scenario, index) => {
                const ages = scenario.results.years.map(y => y.age);
                const annualSpending = scenario.results.years.map(y => y.annualSpending);
                const withdrawalCapacity = scenario.results.years.map(y => y.withdrawalCapacity);
                
                if (index === 0) {
                    allAges = ages;
                }
                
                datasets.push({
                    label: `${scenario.name} - Annual Spending`,
                    data: annualSpending,
                    borderColor: scenario.color,
                    backgroundColor: scenario.color + '20',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5]
                });
                
                datasets.push({
                    label: `${scenario.name} - Withdrawal Capacity`,
                    data: withdrawalCapacity,
                    borderColor: scenario.color,
                    backgroundColor: scenario.color + '20',
                    fill: false,
                    tension: 0.1
                });
            });
            
            spendingChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allAges,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createDebtChart() {
            // Check if any scenario has debt
            const hasDebt = scenarios.some(scenario => 
                scenario.results.years.some(y => y.totalRemainingDebt > 0)
            );
            const debtSection = document.getElementById('debtChartSection');
            
            if (!hasDebt) {
                debtSection.style.display = 'none';
                return;
            }
            
            debtSection.style.display = 'block';
            const ctx = document.getElementById('debtChart').getContext('2d');
            
            if (debtChartInstance) {
                debtChartInstance.destroy();
            }
            
            const datasets = [];
            let allAges = [];
            
            scenarios.forEach((scenario, index) => {
                const ages = scenario.results.years.map(y => y.age);
                const totalDebt = scenario.results.years.map(y => y.totalRemainingDebt);
                
                if (index === 0) {
                    allAges = ages;
                }
                
                if (totalDebt.some(d => d > 0)) {
                    datasets.push({
                        label: `${scenario.name} - Total Debt`,
                        data: totalDebt,
                        borderColor: scenario.color,
                        backgroundColor: scenario.color + '20',
                        fill: false,
                        tension: 0.1
                    });
                }
            });
            
            debtChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allAges,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Remaining Debt ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function populateAllTables() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            if (scenarios.length === 0) return;
            
            // Get all unique years from all scenarios
            const allYears = [...new Set(scenarios.flatMap(s => s.results.years.map(y => y.year)))].sort();
            
            allYears.forEach(year => {
                scenarios.forEach((scenario, scenarioIndex) => {
                    const yearData = scenario.results.years.find(y => y.year === year);
                    if (!yearData) return;
                    
                    const row = document.createElement('tr');
                    row.style.borderLeft = `4px solid ${scenario.color}`;
                    row.style.backgroundColor = scenario.color + '10';
                    
                    if (yearData.status === 'Financial Independence Achieved' && 
                        scenario.results.years[scenario.results.years.indexOf(yearData) - 1]?.status === 'Building') {
                        row.className = 'fi-row';
                    }
                    
                    row.innerHTML = `
                        <td><strong>${scenario.name}</strong> ${yearData.year}</td>
                        <td>${yearData.age}</td>
                        <td>${formatCurrency(yearData.portfolioValue)}</td>
                        <td>${formatCurrency(yearData.annualSpending)}</td>
                        <td>${formatCurrency(yearData.withdrawalCapacity)}</td>
                        <td>${formatCurrency(yearData.contributions)}</td>
                        <td>${formatCurrency(yearData.totalRemainingDebt)}</td>
                        <td class="${yearData.status === 'Building' ? 'status-building' : 'status-fi'}">${yearData.status}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            });
        }

        // SPA Navigation Functions
        let currentPage = 'fi-calculator';

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            // Update navigation active state
            document.querySelectorAll('.nav-menu a').forEach(nav => {
                nav.classList.remove('active');
            });
            
            const activeNav = document.getElementById(`nav-${pageId}`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            currentPage = pageId;
            
            // Handle page-specific logic
            if (pageId === 'fi-calculator') {
                // Ensure totals are updated when returning to calculator
                updateTotalStartingCapital();
                updateTotalContributions();
                syncAccountNames();
            } else if (pageId === 'net-worth') {
                // Initialize net worth page with selected scenario data
                initializeNetWorthPage();
            }
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Initialize SPA
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in - redirect to start if not
            if (!userManager.requireLogin()) {
                return;
            }
            
            // Add player info to UI
            userManager.addPlayerInfoToUI();
            
            // Check if user should be redirected to My Scenario
            // Only redirect if they haven't intentionally accessed the FI Calculator
            const urlParams = new URLSearchParams(window.location.search);
            const intentionalAccess = urlParams.get('access') === 'intentional';
            
            if (userManager.hasCompletedInitialSetup() && !intentionalAccess) {
                window.location.href = 'my-scenario.html';
                return; // Stop execution here
            }
            
            // Load saved scenarios from user data
            loadSavedScenarios();
            
            // Initialize calculator formatting first
            initializeCalculator();
            // Then show the first page
            showPage('fi-calculator');
            
            // Expand Initial Setup section by default since this is the FI Calculator
            const setupSection = document.getElementById('initial-setup-section');
            const setupArrow = document.getElementById('setup-arrow');
            if (setupSection && setupArrow) {
                setupSection.style.display = 'block';
                setupArrow.classList.add('expanded');
            }
        });

        // Toggle Initial Setup section
        function toggleInitialSetup(event) {
            event.preventDefault();
            
            const section = document.getElementById('initial-setup-section');
            const arrow = document.getElementById('setup-arrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }
    </script>
                </div> <!-- Close container -->
            </div> <!-- Close page-fi-calculator -->

            <!-- Scenarios Page -->
            <div id="page-scenarios" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">My Scenarios</h1>
                    <p class="page-subtitle">View and manage your saved FI scenarios</p>
                </div>
                <div class="container" style="max-width: none; margin: 0; padding: 20px; background: #16213e; border-radius: 8px;">
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        🎯 <strong>Coming Soon!</strong><br><br>
                        This page will show your saved FI calculation scenarios.<br>
                        You'll be able to compare different plans and choose one to continue with.
                    </p>
                </div>
            </div>

            <!-- Net Worth Tracking Page -->
            <div id="page-net-worth" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Initial Net Worth Setup</h1>
                    <p class="page-subtitle">Set up your current financial position based on your selected FI scenario</p>
                </div>
                <div class="container" style="max-width: none; margin: 0; padding: 0; background: transparent; box-shadow: none;">
        
        <div class="input-section">
            <!-- 1. Test Content -->
            <div class="input-group">
                <label for="testNetWorth">🔴 NET WORTH TEST 🔴</label>
                <input type="text" id="testNetWorth" value="This should appear to the right of sidebar!" readonly>
            </div>
        </div>
        
                </div> <!-- Close container -->
            </div> <!-- Close page-net-worth -->

            <!-- Budget & Cashflow Page -->
            <div id="page-budget" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Budget</h1>
                    <p class="page-subtitle">Manage your income, expenses, and cash flow</p>
                </div>
                <div class="container" style="max-width: none; margin: 0; padding: 20px; background: #16213e; border-radius: 8px;">
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        📋 <strong>Coming Soon!</strong><br><br>
                        This page will help you track monthly income and expenses.<br>
                        Monitor your actual spending vs. your FI plan targets.
                    </p>
                </div>
            </div>

            <!-- Progress Reports Page -->
            <div id="page-progress" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Progress Reports</h1>
                    <p class="page-subtitle">Visualize your journey to financial independence</p>
                </div>
                <div class="container" style="max-width: none; margin: 0; padding: 20px; background: #16213e; border-radius: 8px;">
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        📈 <strong>Coming Soon!</strong><br><br>
                        This page will show detailed charts and reports.<br>
                        Track your progress with beautiful visualizations and insights.
                    </p>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                    <p class="page-subtitle">Customize your FIQuest experience</p>
                </div>
                <div class="container" style="max-width: none; margin: 0; padding: 20px; background: #16213e; border-radius: 8px;">
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        ⚙️ <strong>Coming Soon!</strong><br><br>
                        This page will let you customize account names, preferences, and more.<br>
                        Export your data and manage your FIQuest settings.
                    </p>
                </div>
            </div>
        </main> <!-- Close main-content -->
    </div> <!-- Close app-container -->
</body>
</html>