<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Scenario - FIQuest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
        }

        .app-container {
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: white;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-menu a.active {
            background: rgba(255,255,255,0.2);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* Collapsible Navigation Styles */
        .nav-section {
            margin: 5px 0;
        }

        .nav-section-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-section-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .toggle-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .toggle-arrow.expanded {
            transform: rotate(90deg);
        }

        .nav-subsection {
            background: rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-subitem {
            display: flex;
            align-items: center;
            padding: 10px 20px 10px 40px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-subitem:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-subitem.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: bold;
        }

        .main-content {
            margin-left: 250px;
            padding: 40px;
            min-height: 100vh;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 36px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .page-subtitle {
            font-size: 18px;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .readonly-input {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 500;
        }

        .account-list, .debt-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .account-item, .debt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .account-name, .debt-name {
            font-weight: 600;
            color: #495057;
        }

        .account-value {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
        }

        .debt-value {
            font-weight: bold;
            color: #dc3545;
            font-size: 16px;
        }

        .results-section {
            margin-top: 30px;
        }

        .key-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .result-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-card .value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-card .label {
            font-size: 12px;
            opacity: 0.8;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #f8f9fa;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
        }

        .data-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #dee2e6;
            color: #495057;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-building {
            color: #ff9800;
            font-weight: bold;
        }

        .status-fi {
            color: #4CAF50;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .input-section {
                grid-template-columns: 1fr;
            }
            
            .key-results {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        /* Chart Styles */
        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        .disclaimer {
            margin: 40px 0;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .disclaimer h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .disclaimer p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            text-align: justify;
        }
    </style>
    <script src="chart.min.js"></script>
    <script src="user-manager.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">FIQuest</h1>
                <p class="user-info">Financial Independence Journey</p>
            </div>
            
            <div class="nav-menu">
                <a href="my-scenario.html" id="nav-scenarios" class="active">
                    <span class="nav-icon">📊</span>
                    My Scenario
                </a>
                <a href="net-worth-tracking.html" id="nav-net-worth-tracking">
                    <span class="nav-icon">📈</span>
                    Net Worth Tracking
                </a>
                <!-- Collapsible Initial Setup Section -->
                <div class="nav-section">
                    <a href="#" class="nav-section-toggle" onclick="toggleInitialSetup(event)">
                        <span class="nav-icon">⚙️</span>
                        Initial Setup
                        <span class="toggle-arrow" id="setup-arrow">▶</span>
                    </a>
                    <div class="nav-subsection" id="initial-setup-section" style="display: none;">
                        <a href="fi-calculator.html?access=intentional" id="nav-fi-calculator" class="nav-subitem">
                            <span class="nav-icon">🧮</span>
                            FI Calculator
                        </a>
                        <a href="net-worth.html" id="nav-net-worth" class="nav-subitem">
                            <span class="nav-icon">💰</span>
                            Net Worth Setup
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">My Scenario</h1>
                <p class="page-subtitle">Your selected financial independence scenario (read-only reference)</p>
            </div>

            <!-- Key Results -->
            <div class="results-section">
                <div class="key-results">
                    <div class="result-card">
                        <h3>Financial Independence Year</h3>
                        <div class="value" id="fiYear">-</div>
                    </div>
                    <div class="result-card">
                        <h3>FI Age</h3>
                        <div class="value" id="fiAge">-</div>
                    </div>
                    <div class="result-card">
                        <h3>Portfolio Value at FI</h3>
                        <div class="value" id="fiPortfolio">-</div>
                    </div>
                </div>
            </div>

            <!-- Basic Information -->
            <div class="container">
                <div class="section-title">📋 Basic Information</div>
                <div class="input-section">
                    <div class="input-group">
                        <label>Current Age</label>
                        <div class="readonly-input" id="currentAge">0</div>
                    </div>
                    <div class="input-group">
                        <label>Life Expectancy</label>
                        <div class="readonly-input" id="lifeExpectancy">0</div>
                    </div>
                    <div class="input-group">
                        <label>Active Until Age</label>
                        <div class="readonly-input" id="activeUntilAge">0</div>
                    </div>
                </div>
            </div>

            <!-- Financial Details -->
            <div class="container">
                <div class="section-title">💰 Financial Details</div>
                <div class="input-section">
                    <div class="input-group">
                        <label>Active Annual Spending</label>
                        <div class="readonly-input" id="activeSpending">$0</div>
                    </div>
                    <div class="input-group">
                        <label>Inactive Annual Spending</label>
                        <div class="readonly-input" id="inactiveSpending">$0</div>
                    </div>
                    <div class="input-group">
                        <label>Annual Rate of Return</label>
                        <div class="readonly-input" id="rateOfReturn">0%</div>
                    </div>
                    <div class="input-group">
                        <label>Annual Contributions</label>
                        <div class="readonly-input" id="annualContributions">$0</div>
                    </div>
                    <div class="input-group">
                        <label>Inflation Rate</label>
                        <div class="readonly-input" id="inflationRate">0%</div>
                    </div>
                    <div class="input-group">
                        <label>Withdrawal Rate</label>
                        <div class="readonly-input" id="withdrawalRate">0%</div>
                    </div>
                </div>
            </div>

            <!-- Investment Accounts -->
            <div class="container">
                <div class="section-title">📈 Investment Accounts</div>
                <div id="accountsList" class="account-list">
                    <div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">No investment accounts configured</div>
                </div>
            </div>

            <!-- Debt Information -->
            <div class="container">
                <div class="section-title">🏠 Debt Information</div>
                <div id="debtsList" class="debt-list">
                    <div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">No debts configured</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="container">
                <div class="section-title">📈 Financial Projections</div>

                <!-- Portfolio Value Chart -->
                <div class="chart-container">
                    <h3 class="chart-title">Portfolio Value Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>

                <!-- Spending vs Withdrawal Chart -->
                <div class="chart-container">
                    <h3 class="chart-title">Annual Spending vs Withdrawal Capacity</h3>
                    <div class="chart-wrapper">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>

                <!-- Debt Balance Chart -->
                <div class="chart-container">
                    <h3 class="chart-title">Remaining Debt Balance</h3>
                    <div class="chart-wrapper">
                        <canvas id="debtChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Yearly Projections Table -->
            <div class="container">
                <div class="section-title">📊 Yearly Financial Projections</div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="yearlyDataTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Age</th>
                                <th>Portfolio Value</th>
                                <th>Annual Spending</th>
                                <th>Withdrawal Capacity</th>
                                <th>Net Contributions</th>
                                <th>Remaining Debt</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" style="text-align: center; color: #666; padding: 20px;">No scenario data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="disclaimer">
                    <h3>Disclaimer</h3>
                    <p>This material is provided for general informational purposes only and does not constitute financial, investment, tax, legal or accounting advice, it should not be relied upon in that regard or be considered predictive of any future market performance, nor does it constitute an offer or solicitation to buy or sell any securities referred to. Individual circumstances and current events are critical to sound investment planning; anyone wishing to act on this material should consult with their advisor. Before making any investment decisions, we encourage you to consider these and other factors carefully. Past performance may not be repeated and is not indicative of future results.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        function formatCurrency(amount) {
            if (amount === 0 || amount === null || amount === undefined) return '$0';
            return '$' + Math.round(amount).toLocaleString();
        }

        function formatPercentage(rate) {
            if (rate === 0 || rate === null || rate === undefined) return '0%';
            return (rate * 100).toFixed(1) + '%';
        }

        function loadScenarioData() {
            console.log('Loading scenario data...');
            
            // Get the active scenario from localStorage
            const activeScenarioData = localStorage.getItem('fiquest_active_scenario');
            
            if (!activeScenarioData) {
                console.log('No scenario data found - displaying zeros');
                displayDefaultData();
                return;
            }

            try {
                const scenario = JSON.parse(activeScenarioData);
                console.log('Successfully loaded scenario:', scenario.name || 'Unnamed Scenario');
                displayScenarioData(scenario);
            } catch (error) {
                console.error('Error parsing scenario data:', error);
                displayDefaultData();
            }
        }

        function displayDefaultData() {
            // Display zero values for all fields
            document.getElementById('fiYear').textContent = '-';
            document.getElementById('fiAge').textContent = '-';
            document.getElementById('fiPortfolio').textContent = '$0';
            
            document.getElementById('currentAge').textContent = '0';
            document.getElementById('lifeExpectancy').textContent = '0';
            document.getElementById('activeUntilAge').textContent = '0';
            
            document.getElementById('activeSpending').textContent = '$0';
            document.getElementById('inactiveSpending').textContent = '$0';
            document.getElementById('rateOfReturn').textContent = '0%';
            document.getElementById('annualContributions').textContent = '$0';
            document.getElementById('inflationRate').textContent = '0%';
            document.getElementById('withdrawalRate').textContent = '$0';
            
            // Clear accounts and debts
            document.getElementById('accountsList').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">No investment accounts configured</div>';
            document.getElementById('debtsList').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">No debts configured</div>';
            
            // Clear table
            const tbody = document.querySelector('#yearlyDataTable tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">No scenario data available</td></tr>';
        }

        function displayScenarioData(scenario) {
            // Display key results
            if (scenario.results) {
                const fiYearText = scenario.results.fiYear ? 
                    `${scenario.results.fiYear}` : 'Not Achieved';
                document.getElementById('fiYear').textContent = fiYearText;
                
                const fiAgeText = scenario.results.fiAge ? 
                    `Age ${scenario.results.fiAge}` : '-';
                document.getElementById('fiAge').textContent = fiAgeText;
                
                // Use portfolio value from the year when FI is achieved
                let fiPortfolioValue = 0;
                if (scenario.results.years && scenario.results.fiYear) {
                    const fiYearData = scenario.results.years.find(year => 
                        year.year === scenario.results.fiYear && 
                        year.status === 'Financial Independence Achieved'
                    );
                    fiPortfolioValue = fiYearData ? fiYearData.portfolioValue : 
                        (scenario.results.fiPortfolioValue || scenario.results.totalRequired || 0);
                } else {
                    fiPortfolioValue = scenario.results.fiPortfolioValue || scenario.results.totalRequired || 0;
                }
                document.getElementById('fiPortfolio').textContent = formatCurrency(fiPortfolioValue);
            }

            // Display basic information
            const inputs = scenario.inputs || {};
            document.getElementById('currentAge').textContent = inputs.currentAge || '0';
            document.getElementById('lifeExpectancy').textContent = inputs.lifeExpectancy || '0';
            document.getElementById('activeUntilAge').textContent = inputs.activeUntilAge || '0';

            // Display financial details
            document.getElementById('activeSpending').textContent = formatCurrency(inputs.activeSpending || 0);
            document.getElementById('inactiveSpending').textContent = formatCurrency(inputs.inactiveSpending || 0);
            document.getElementById('rateOfReturn').textContent = formatPercentage(inputs.rateOfReturn || 0);
            document.getElementById('annualContributions').textContent = formatCurrency(inputs.annualContributions || 0);
            document.getElementById('inflationRate').textContent = formatPercentage(inputs.inflationRate || 0);
            document.getElementById('withdrawalRate').textContent = formatPercentage(inputs.withdrawalRate || 0);

            // Display investment accounts
            displayAccounts(inputs.accounts || []);

            // Display debts
            displayDebts(inputs.debts || {});

            // Display yearly data table
            if (scenario.results && scenario.results.years) {
                displayYearlyDataTable(scenario.results.years);
                // Create charts with yearly data
                createPortfolioChart(scenario.results.years);
                createSpendingChart(scenario.results.years, inputs);
                createDebtChart(scenario.results.years);
            } else {
                // Hide charts if no yearly data available
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach(container => container.style.display = 'none');
            }
        }

        function displayAccounts(accounts) {
            const accountsList = document.getElementById('accountsList');
            accountsList.innerHTML = '';

            if (!accounts || accounts.length === 0) {
                accountsList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">No investment accounts configured</div>';
                return;
            }

            accounts.forEach(account => {
                if (account.value && account.value > 0) {
                    const accountDiv = document.createElement('div');
                    accountDiv.className = 'account-item';
                    accountDiv.innerHTML = `
                        <span class="account-name">${account.name}</span>
                        <span class="account-value">${formatCurrency(account.value)}</span>
                    `;
                    accountsList.appendChild(accountDiv);
                }
            });
        }

        function displayDebts(debts) {
            const debtsList = document.getElementById('debtsList');
            debtsList.innerHTML = '';

            const debtTypes = [
                { key: 'mortgage', name: 'Mortgage' },
                { key: 'vehicle', name: 'Vehicle Loan' },
                { key: 'other', name: 'Other Debt' }
            ];

            let hasDebts = false;

            debtTypes.forEach(debtType => {
                const debt = debts[debtType.key];
                if (debt && debt.balance > 0) {
                    hasDebts = true;
                    const debtDiv = document.createElement('div');
                    debtDiv.className = 'debt-item';
                    
                    const paymentInfo = debt.payment > 0 ? 
                        ` (${formatCurrency(debt.payment)}/month)` : '';
                    
                    debtDiv.innerHTML = `
                        <span class="debt-name">${debtType.name}${paymentInfo}</span>
                        <span class="debt-value">${formatCurrency(debt.balance)}</span>
                    `;
                    debtsList.appendChild(debtDiv);
                }
            });

            if (!hasDebts) {
                debtsList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">No debts configured</div>';
            }
        }

        function displayYearlyDataTable(years) {
            const tbody = document.querySelector('#yearlyDataTable tbody');
            tbody.innerHTML = '';

            if (!years || years.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">No yearly projection data available</td></tr>';
                return;
            }

            years.forEach(yearData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${yearData.year}</strong></td>
                    <td>${yearData.age}</td>
                    <td>${formatCurrency(yearData.portfolioValue)}</td>
                    <td>${formatCurrency(yearData.annualSpending)}</td>
                    <td>${formatCurrency(yearData.withdrawalCapacity || 0)}</td>
                    <td>${formatCurrency(yearData.contributions || 0)}</td>
                    <td>${formatCurrency(yearData.totalRemainingDebt || 0)}</td>
                    <td><span class="${yearData.status === 'Building' ? 'status-building' : 'status-fi'}">${yearData.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }


        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!userManager.requireLogin()) {
                return;
            }
            
            // Add player info to UI
            userManager.addPlayerInfoToUI();
            
            // Load player game data to sync localStorage
            userManager.loadPlayerGameData();
            
            // Load scenario data
            loadScenarioData();
        });

        // Chart Creation Functions
        let portfolioChart, spendingChart, debtChart;

        function createPortfolioChart(yearlyData) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');

            // Destroy existing chart if it exists
            if (portfolioChart) {
                portfolioChart.destroy();
            }

            const ages = yearlyData.map(data => data.age);
            const portfolioValues = yearlyData.map(data => data.portfolioValue || 0);

            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: portfolioValues,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Portfolio Value ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function createSpendingChart(yearlyData, inputs) {
            const ctx = document.getElementById('spendingChart').getContext('2d');

            // Destroy existing chart if it exists
            if (spendingChart) {
                spendingChart.destroy();
            }

            const ages = yearlyData.map(data => data.age);
            const annualSpending = yearlyData.map(data => data.annualSpending || 0);
            const withdrawalCapacity = yearlyData.map(data => data.withdrawalCapacity || 0);

            spendingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages,
                    datasets: [{
                        label: 'Annual Spending',
                        data: annualSpending,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    }, {
                        label: 'Withdrawal Capacity',
                        data: withdrawalCapacity,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function createDebtChart(yearlyData) {
            const ctx = document.getElementById('debtChart').getContext('2d');

            // Destroy existing chart if it exists
            if (debtChart) {
                debtChart.destroy();
            }

            const ages = yearlyData.map(data => data.age);
            const totalRemainingDebt = yearlyData.map(data => data.totalRemainingDebt || 0);

            // Only show chart if there's debt data
            const hasDebtData = totalRemainingDebt.some(debt => debt > 0);

            if (!hasDebtData) {
                // Hide the chart container if no debt
                document.querySelector('#debtChart').closest('.chart-container').style.display = 'none';
                return;
            } else {
                document.querySelector('#debtChart').closest('.chart-container').style.display = 'block';
            }

            debtChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages,
                    datasets: [{
                        label: 'Total Remaining Debt',
                        data: totalRemainingDebt,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Debt ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        // Toggle Initial Setup section
        function toggleInitialSetup(event) {
            event.preventDefault();
            
            const section = document.getElementById('initial-setup-section');
            const arrow = document.getElementById('setup-arrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }
    </script>
</body>
</html>