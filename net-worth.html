<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth Tracking - FIQuest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
        }

        .app-container {
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: white;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-menu a.active {
            background: rgba(255,255,255,0.2);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* Collapsible Navigation Styles */
        .nav-section {
            margin: 5px 0;
        }

        .nav-section-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-section-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .toggle-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .nav-subsection {
            background: rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-subitem {
            display: flex;
            align-items: center;
            padding: 10px 20px 10px 40px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-subitem:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-subitem.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: bold;
        }

        .main-content {
            margin-left: 250px;
            padding: 0;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-title {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            font-size: 16px;
            margin: 0;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        input[readonly] {
            background-color: #f8f9fa;
        }

        .calculate-btn, .clear-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .calculate-btn:hover, .clear-btn:hover {
            background: #5a67d8;
        }

        .scenario-controls {
            text-align: center;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .page {
                padding: 20px 10px;
            }

            .input-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .disclaimer {
            margin: 40px 0;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .disclaimer h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .disclaimer p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            text-align: justify;
        }
    </style>
    <script src="user-manager.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">FIQuest</h1>
                <p class="user-info">Financial Independence Journey</p>
            </div>
            
            <div class="nav-menu">
                <a href="my-scenario.html" id="nav-scenarios">
                    <span class="nav-icon">üìä</span>
                    My Scenario
                </a>
                <a href="net-worth-tracking.html" id="nav-net-worth-tracking">
                    <span class="nav-icon">üìà</span>
                    Net Worth Tracking
                </a>
                <!-- Collapsible Initial Setup Section -->
                <div class="nav-section">
                    <a href="#" class="nav-section-toggle" onclick="toggleInitialSetup(event)">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Initial Setup
                        <span class="toggle-arrow" id="setup-arrow">‚ñº</span>
                    </a>
                    <div class="nav-subsection" id="initial-setup-section">
                        <a href="fi-calculator.html?access=intentional" id="nav-fi-calculator" class="nav-subitem">
                            <span class="nav-icon">üßÆ</span>
                            FI Calculator
                        </a>
                        <a href="net-worth.html" id="nav-net-worth" class="nav-subitem active">
                            <span class="nav-icon">üí∞</span>
                            Net Worth Setup
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="page">
                <div class="page-header">
                    <h1 class="page-title">Net Worth Tracking</h1>
                    <p class="page-subtitle">Track your actual net worth progress vs. projected values</p>
                </div>
                <div class="container">
                    <!-- Scenario Display -->
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px 0; color: #2e7d32;">Selected FI Scenario</h3>
                        <p id="scenarioNameDisplay" style="margin: 0; font-weight: bold; color: #1565c0;">Loading...</p>
                    </div>

                    <!-- Assets Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2e7d32; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-bottom: 20px;">üìà Assets</h3>
                        
                        <!-- Investment Accounts from Scenario -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #666;">Investment Accounts (from FI scenario)</h4>
                            <div id="investmentAccountsList"></div>
                            <div style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                <span style="font-weight: bold;">Total:</span>
                                <input type="text" id="totalInvestmentAccounts" readonly style="background: #e9ecef; border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                            </div>
                        </div>

                        <!-- Additional Assets -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: #666;">Additional Assets</h4>
                            <div id="additionalAssetsList">
                                <div class="asset-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="asset1Name" value="Cash" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="asset1Value" value="15,000" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                                <div class="asset-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="asset2Name" value="Home" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="asset2Value" value="1,500,000" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                                <div class="asset-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="asset3Name" value="Stock Options/RSUs" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="asset3Value" value="150,000" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                                <div class="asset-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="asset4Name" value="Crypto" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="asset4Value" value="35,000" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                                <div class="asset-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="asset5Name" value="Other" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="asset5Value" value="1,000" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                            </div>
                        </div>

                        <!-- Total Assets -->
                        <div style="text-align: right; margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50;">
                            <label style="font-size: 18px; font-weight: bold; color: #2e7d32;">Total Assets: </label>
                            <input type="text" id="totalAssets" readonly style="font-size: 18px; font-weight: bold; background: #e8f5e8; border: 2px solid #4CAF50; padding: 8px; border-radius: 4px; color: #2e7d32; width: 150px;">
                        </div>
                    </div>

                    <!-- Liabilities Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #d32f2f; border-bottom: 2px solid #f44336; padding-bottom: 10px; margin-bottom: 20px;">üìâ Liabilities</h3>
                        
                        <!-- Scenario Debts -->
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #666;">Debts (from FI scenario)</h4>
                            <div id="scenarioDebtsList"></div>
                            <div style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                <span style="font-weight: bold;">Total:</span>
                                <input type="text" id="totalScenarioDebts" readonly style="background: #e9ecef; border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                            </div>
                        </div>

                        <!-- Additional Liabilities -->
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: #666;">Additional Liabilities</h4>
                            <div id="additionalLiabilitiesList">
                                <div class="liability-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="liability1Name" value="HELOC" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="liability1Value" value="0" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                                <div class="liability-item" style="display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" id="liability2Name" value="Other" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
                                    <input type="text" id="liability2Value" value="0" oninput="updateNetWorth()" style="border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-weight: bold;">
                                </div>
                            </div>
                        </div>

                        <!-- Total Liabilities -->
                        <div style="text-align: right; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f44336;">
                            <label style="font-size: 18px; font-weight: bold; color: #d32f2f;">Total Liabilities: </label>
                            <input type="text" id="totalLiabilities" readonly style="font-size: 18px; font-weight: bold; background: #ffebee; border: 2px solid #f44336; padding: 8px; border-radius: 4px; color: #d32f2f; width: 150px;">
                        </div>
                    </div>

                    <!-- Net Worth Calculation -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 10px 0;">üí∞ Current Net Worth</h3>
                        <input type="text" id="currentNetWorth" readonly style="font-size: 24px; font-weight: bold; background: rgba(255,255,255,0.9); border: none; padding: 10px; border-radius: 4px; color: #333; text-align: center; width: 200px;">
                    </div>

                    <!-- Asset Allocation Chart -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px;">üìä Asset Allocation</h3>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="height: 400px; position: relative;">
                                <canvas id="assetAllocationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="scenario-controls">
                        <button class="calculate-btn" onclick="saveNetWorthSetup()">Save Net Worth Setup</button>
                        <button class="clear-btn" onclick="window.location.href='net-worth-tracking.html'">Next: Net Worth Tracking ‚Üí</button>
                    </div>

                    <div class="disclaimer">
                        <h3>Disclaimer</h3>
                        <p>This material is provided for general informational purposes only and does not constitute financial, investment, tax, legal or accounting advice, it should not be relied upon in that regard or be considered predictive of any future market performance, nor does it constitute an offer or solicitation to buy or sell any securities referred to. Individual circumstances and current events are critical to sound investment planning; anyone wishing to act on this material should consult with their advisor. Before making any investment decisions, we encourage you to consider these and other factors carefully. Past performance may not be repeated and is not indicative of future results.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Net Worth Setup Functions
        let assetAllocationChart = null;

        function initializeNetWorthPage() {
            const activeScenario = JSON.parse(localStorage.getItem('fiquest_active_scenario') || 'null');
            
            if (activeScenario) {
                // Debug: Log the scenario structure to console
                console.log('Active Scenario Data:', activeScenario);
                console.log('Debts Data:', activeScenario.inputs?.debts);
                
                // Display selected scenario info
                document.getElementById('scenarioNameDisplay').textContent = activeScenario.name;
                
                // Populate investment accounts from scenario
                populateInvestmentAccounts(activeScenario);
                
                // Populate scenario debts
                populateScenarioDebts(activeScenario);
            } else {
                // No scenario selected - show default/empty state for testing
                document.getElementById('scenarioNameDisplay').textContent = 'No Scenario Selected (Demo Mode)';
                
                // Populate with demo/default investment accounts
                populateDefaultInvestmentAccounts();
                
                // Populate with demo/default debts
                populateDefaultScenarioDebts();
            }
            
            // Initialize currency formatting for default values
            initializeNetWorthInputs();
            
            // Update calculations
            updateNetWorth();
        }

        function populateDefaultInvestmentAccounts() {
            const accountsList = document.getElementById('investmentAccountsList');
            let totalInvestment = 0;
            
            accountsList.innerHTML = '';
            
            // Default demo investment accounts for testing
            const defaultAccounts = [
                { name: 'RRSP1', value: 250000 },
                { name: 'RRSP2', value: 150000 },
                { name: 'TFSA1', value: 300000 },
                { name: 'TFSA2', value: 200000 },
                { name: 'Taxable Brokerage', value: 100000 }
            ];
            
            defaultAccounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = account.name;
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(account.value);
                valueSpan.style.fontWeight = 'bold';
                
                accountDiv.appendChild(nameSpan);
                accountDiv.appendChild(valueSpan);
                accountsList.appendChild(accountDiv);
                
                totalInvestment += account.value;
            });
            
            document.getElementById('totalInvestmentAccounts').value = '$' + formatNumber(totalInvestment);
        }

        function populateDefaultScenarioDebts() {
            const debtsList = document.getElementById('scenarioDebtsList');
            let totalDebt = 0;
            
            debtsList.innerHTML = '';
            
            // Only show debts if they exist in scenario data (no default demo debts)
            const scenario = JSON.parse(localStorage.getItem('fiquest_active_scenario'));
            const scenarioDebts = [];
            
            if (scenario && scenario.inputs && scenario.inputs.debts) {
                const debts = scenario.inputs.debts;
                if (debts.mortgage && debts.mortgage.balance > 0) {
                    scenarioDebts.push({ name: 'Mortgage', value: debts.mortgage.balance });
                }
                if (debts.vehicle && debts.vehicle.balance > 0) {
                    scenarioDebts.push({ name: 'Vehicle Loan', value: debts.vehicle.balance });
                }
                if (debts.other && debts.other.balance > 0) {
                    scenarioDebts.push({ name: 'Other Debt', value: debts.other.balance });
                }
            }
            
            if (scenarioDebts.length === 0) {
                // Show message when no debts exist
                const noDebtsDiv = document.createElement('div');
                noDebtsDiv.style.cssText = 'padding: 20px; text-align: center; color: #666; font-style: italic;';
                noDebtsDiv.textContent = 'No debts found in selected scenario';
                debtsList.appendChild(noDebtsDiv);
                
                document.getElementById('totalScenarioDebts').value = '$0';
                return;
            }
            
            scenarioDebts.forEach(debt => {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = debt.name;
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(debt.value);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += debt.value;
            });
            
            document.getElementById('totalScenarioDebts').value = '$' + formatNumber(totalDebt);
        }

        function populateInvestmentAccounts(scenario) {
            const accountsList = document.getElementById('investmentAccountsList');
            let totalInvestment = 0;
            
            accountsList.innerHTML = '';
            
            if (scenario.inputs && scenario.inputs.accounts && scenario.inputs.accounts.length > 0) {
                // Use actual account data from scenario
                scenario.inputs.accounts.forEach(account => {
                    const accountDiv = document.createElement('div');
                    accountDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = account.name;
                    nameSpan.style.color = '#666';
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = '$' + formatNumber(account.value);
                    valueSpan.style.fontWeight = 'bold';
                    
                    accountDiv.appendChild(nameSpan);
                    accountDiv.appendChild(valueSpan);
                    accountsList.appendChild(accountDiv);
                    
                    totalInvestment += account.value;
                });
            } else {
                // Fallback to defaults if no account data available
                populateDefaultInvestmentAccounts();
                return;
            }
            
            document.getElementById('totalInvestmentAccounts').value = '$' + formatNumber(totalInvestment);
        }

        function populateScenarioDebts(scenario) {
            const debtsList = document.getElementById('scenarioDebtsList');
            let totalDebt = 0;
            
            debtsList.innerHTML = '';
            
            // Debug logging
            console.log('populateScenarioDebts called with:', scenario);
            console.log('Debts object:', scenario.inputs?.debts);
            
            // Check mortgage from scenario data
            if (scenario.inputs?.debts?.mortgage && scenario.inputs.debts.mortgage.balance > 0) {
                const mortgageBalance = scenario.inputs.debts.mortgage.balance;
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Mortgage';
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(mortgageBalance);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += mortgageBalance;
            }
            
            // Check vehicle loan from scenario data
            if (scenario.inputs?.debts?.vehicle && scenario.inputs.debts.vehicle.balance > 0) {
                const vehicleBalance = scenario.inputs.debts.vehicle.balance;
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Vehicle Loan';
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(vehicleBalance);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += vehicleBalance;
            }
            
            // Check other debt from scenario data
            if (scenario.inputs?.debts?.other && scenario.inputs.debts.other.balance > 0) {
                const otherBalance = scenario.inputs.debts.other.balance;
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Other Debt';
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(otherBalance);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += otherBalance;
            }
            
            // If no debts found, show a message
            if (totalDebt === 0) {
                const noDebtsDiv = document.createElement('div');
                noDebtsDiv.style.cssText = 'color: #666; font-style: italic; text-align: center; padding: 10px;';
                noDebtsDiv.textContent = 'No debts from FI scenario';
                debtsList.appendChild(noDebtsDiv);
            }
            
            document.getElementById('totalScenarioDebts').value = '$' + formatNumber(totalDebt);
        }

        function initializeNetWorthInputs() {
            // Format currency inputs for additional assets
            const assetInputs = ['asset1Value', 'asset2Value', 'asset3Value', 'asset4Value', 'asset5Value'];
            assetInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    formatCurrencyInput(element);
                }
            });
            
            // Format currency inputs for additional liabilities
            const liabilityInputs = ['liability1Value', 'liability2Value'];
            liabilityInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    formatCurrencyInput(element);
                }
            });
        }

        function updateNetWorth() {
            // Calculate total assets
            let totalAssets = 0;
            
            // Add investment accounts total
            const investmentTotal = unformatNumber(document.getElementById('totalInvestmentAccounts').value.replace('$', ''));
            totalAssets += investmentTotal;
            
            // Add additional assets
            for (let i = 1; i <= 5; i++) {
                const assetValue = unformatNumber(document.getElementById(`asset${i}Value`).value);
                totalAssets += assetValue;
            }
            
            // Calculate total liabilities
            let totalLiabilities = 0;
            
            // Add scenario debts total
            const scenarioDebtsTotal = unformatNumber(document.getElementById('totalScenarioDebts').value.replace('$', ''));
            totalLiabilities += scenarioDebtsTotal;
            
            // Add additional liabilities
            for (let i = 1; i <= 2; i++) {
                const liabilityValue = unformatNumber(document.getElementById(`liability${i}Value`).value);
                totalLiabilities += liabilityValue;
            }
            
            // Update displays
            document.getElementById('totalAssets').value = '$' + formatNumber(totalAssets);
            document.getElementById('totalLiabilities').value = '$' + formatNumber(totalLiabilities);
            
            const netWorth = totalAssets - totalLiabilities;
            document.getElementById('currentNetWorth').value = '$' + formatNumber(netWorth);
            
            // Update asset allocation chart
            updateAssetAllocationChart(totalAssets);
        }

        function updateAssetAllocationChart(totalAssets) {
            const ctx = document.getElementById('assetAllocationChart').getContext('2d');
            
            if (assetAllocationChart) {
                assetAllocationChart.destroy();
            }
            
            // Gather data for chart
            const data = [];
            const labels = [];
            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#607D8B', '#795548', '#E91E63', '#00BCD4'];
            
            // Investment accounts (combined as "Stocks")
            const investmentTotal = unformatNumber(document.getElementById('totalInvestmentAccounts').value.replace('$', ''));
            if (investmentTotal > 0) {
                data.push(((investmentTotal / totalAssets) * 100).toFixed(1));
                labels.push('Stocks');
            }
            
            // Additional assets
            for (let i = 1; i <= 5; i++) {
                const assetValue = unformatNumber(document.getElementById(`asset${i}Value`).value);
                const assetName = document.getElementById(`asset${i}Name`).value;
                
                if (assetValue > 0) {
                    data.push(((assetValue / totalAssets) * 100).toFixed(1));
                    labels.push(assetName);
                }
            }
            
            assetAllocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function saveNetWorthSetup() {
            const currentDate = new Date();
            const scenario = JSON.parse(localStorage.getItem('fiquest_active_scenario'));
            
            // Capture individual investment accounts
            const investmentAccountsArray = [];
            if (scenario && scenario.inputs && scenario.inputs.accounts) {
                // Use actual account data from scenario
                scenario.inputs.accounts.forEach(account => {
                    investmentAccountsArray.push({
                        name: account.name,
                        value: account.value
                    });
                });
            } else {
                // Use default accounts if no scenario accounts available
                const defaultAccounts = [
                    { name: 'RRSP1', value: 250000 },
                    { name: 'RRSP2', value: 150000 },
                    { name: 'TFSA1', value: 300000 },
                    { name: 'TFSA2', value: 200000 },
                    { name: 'Taxable Brokerage', value: 100000 }
                ];
                investmentAccountsArray.push(...defaultAccounts);
            }
            
            // Capture individual scenario debts  
            const scenarioDebtsArray = [];
            if (scenario && scenario.inputs && scenario.inputs.debts) {
                // Extract individual debt types from scenario structure
                const debts = scenario.inputs.debts;
                
                if (debts.mortgage && debts.mortgage.balance > 0) {
                    scenarioDebtsArray.push({
                        name: 'Mortgage',
                        value: debts.mortgage.balance
                    });
                }
                
                if (debts.vehicle && debts.vehicle.balance > 0) {
                    scenarioDebtsArray.push({
                        name: 'Vehicle Loan',
                        value: debts.vehicle.balance
                    });
                }
                
                if (debts.other && debts.other.balance > 0) {
                    scenarioDebtsArray.push({
                        name: 'Other Debt',
                        value: debts.other.balance
                    });
                }
                
                // Only use debts if they actually exist (no defaults)
                console.log('Scenario debts found:', scenarioDebtsArray.length);
            } else {
                console.log('No scenario debt data available - will save empty debt array');
            }

            const netWorthData = {
                timestamp: currentDate.toISOString(),
                setupDate: currentDate.toISOString().split('T')[0], // YYYY-MM-DD format
                setupYear: currentDate.getFullYear(),
                scenario: scenario,
                assets: {
                    investmentAccounts: investmentAccountsArray,
                    additionalAssets: {}
                },
                liabilities: {
                    scenarioDebts: scenarioDebtsArray,
                    additionalLiabilities: {}
                },
                totals: {
                    totalAssets: parseFloat(document.getElementById('totalAssets').value.replace(/[$,]/g, '')),
                    totalLiabilities: parseFloat(document.getElementById('totalLiabilities').value.replace(/[$,]/g, '')),
                    netWorth: parseFloat(document.getElementById('currentNetWorth').value.replace(/[$,]/g, ''))
                }
            };
            
            // Capture additional asset data with names and values
            for (let i = 1; i <= 5; i++) {
                const name = document.getElementById(`asset${i}Name`).value;
                const value = parseFloat(document.getElementById(`asset${i}Value`).value.replace(/[$,]/g, '')) || 0;
                if (name && name.trim() !== '') {
                    netWorthData.assets.additionalAssets[name] = value;
                }
            }
            
            // Capture additional liability data with names and values
            for (let i = 1; i <= 2; i++) {
                const name = document.getElementById(`liability${i}Name`).value;
                const value = parseFloat(document.getElementById(`liability${i}Value`).value.replace(/[$,]/g, '')) || 0;
                if (name && name.trim() !== '') {
                    netWorthData.liabilities.additionalLiabilities[name] = value;
                }
            }
            
            // Save comprehensive data for use across all app pages
            localStorage.setItem('fiquest_net_worth_setup', JSON.stringify(netWorthData));
            
            // Also save a simplified version for easy access by other pages
            const simplifiedData = {
                timestamp: netWorthData.timestamp,
                netWorth: netWorthData.totals.netWorth,
                totalAssets: netWorthData.totals.totalAssets,
                totalLiabilities: netWorthData.totals.totalLiabilities
            };
            localStorage.setItem('fiquest_current_net_worth', JSON.stringify(simplifiedData));
            
            console.log('Saved net worth setup with individual accounts:', netWorthData);
            alert('Net Worth Setup saved successfully! All data is now available across the FIQuest app.');
        }

        // Utility functions
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function unformatNumber(str) {
            return parseFloat(str.replace(/[$,]/g, '')) || 0;
        }

        function formatCurrencyInput(input) {
            input.addEventListener('input', function() {
                let value = this.value.replace(/[$,]/g, '');
                if (!isNaN(value) && value !== '') {
                    this.value = formatNumber(value);
                }
            });
            
            // Format initial value
            let initialValue = input.value.replace(/[$,]/g, '');
            if (!isNaN(initialValue) && initialValue !== '') {
                input.value = formatNumber(initialValue);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in - redirect to start if not
            if (!userManager.requireLogin()) {
                return;
            }
            
            // Add player info to UI
            userManager.addPlayerInfoToUI();
            
            initializeNetWorthPage();
            
            // Expand Initial Setup section by default since this is Net Worth Setup
            const setupSection = document.getElementById('initial-setup-section');
            const setupArrow = document.getElementById('setup-arrow');
            if (setupSection && setupArrow) {
                setupSection.style.display = 'block';
                setupArrow.classList.add('expanded');
            }
        });

        // Toggle Initial Setup section
        function toggleInitialSetup(event) {
            event.preventDefault();
            
            const section = document.getElementById('initial-setup-section');
            const arrow = document.getElementById('setup-arrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }
    </script>
</body>
</html>