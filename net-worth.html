<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth Setup - FIQuest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
            color: #ffffff;
            background: #1a1a2e;
        }

        /* Typography System */
        h1, .text-xl { font-size: 28px; font-weight: 300; line-height: 1.2; }
        h2, .text-lg { font-size: 24px; font-weight: 500; line-height: 1.3; }
        h3, .text-md { font-size: 18px; font-weight: 500; line-height: 1.4; }
        h4, .text-sm { font-size: 16px; font-weight: 500; line-height: 1.4; }
        .text-xs { font-size: 14px; font-weight: 400; line-height: 1.4; }
        .text-micro { font-size: 12px; font-weight: 400; line-height: 1.3; }

        .font-light { font-weight: 300; }
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .app-container {
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #0E0E55 0%, #0E0E55 100%);
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: white;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 16px;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-menu a.active {
            background: rgba(255,255,255,0.2);
            font-weight: bold;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* Collapsible Navigation Styles */
        .nav-section {
            margin: 5px 0;
        }

        .nav-section-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-section-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .toggle-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .nav-subsection {
            background: rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-subitem {
            display: flex;
            align-items: center;
            padding: 10px 20px 10px 40px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-subitem:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            padding-left: 45px !important;
        }

        .nav-subitem.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: bold;
            border-right: 3px solid #fff;
        }

        .main-content {
            margin-left: 250px;
            padding: 0;
            background: #1a1a2e;
            min-height: 100vh;
        }

        .page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-title {
            color: #ffffff;
            font-size: 28px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 300;
            line-height: 1.2;
        }

        .page-subtitle {
            color: #666;
            font-size: 16px;
            margin: 0;
            text-align: center;
            font-weight: 400;
            line-height: 1.4;
        }

        .container {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 400;
            box-sizing: border-box;
            font-family: inherit;
        }

        input[readonly] {
            background-color: #1a1a2e;
            color: #6c757d;
            border: 1px solid #e9ecef;
            cursor: not-allowed;
            font-weight: 500;
        }

        .calculate-btn, .clear-btn {
            background: #0E0E55;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .calculate-btn:hover, .clear-btn:hover {
            background: #5a67d8;
        }

        .scenario-controls {
            text-align: center;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .page {
                padding: 20px 10px;
            }

            .input-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .disclaimer {
            margin: 40px 0;
            padding: 30px;
            background-color: #1a1a2e;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .disclaimer h3 {
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .disclaimer p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            text-align: justify;
        }

        /* Grid Layout Styles */
        .item-grid {
            display: grid;
            grid-template-columns: 150px 150px;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .total-grid {
            display: grid;
            grid-template-columns: 150px 150px;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        /* Input Field Variants */
        .asset-name-input {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 6px;
            background: #16213e;
            font-size: 14px;
        }

        .asset-value-input {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 6px;
            font-weight: 400;
            font-size: 14px;
        }

        .readonly-total-input {
            background: #1a1a2e;
            border: 1px solid #e9ecef;
            padding: 5px;
            border-radius: 6px;
            font-weight: 400;
            font-size: 14px;
            color: #6c757d;
            cursor: not-allowed;
        }

        .total-label-span {
            font-weight: 400;
            font-size: 14px;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #D3AF37;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .mobile-menu-btn:hover {
            background: #B8941E;
        }

        /* Enhanced Mobile Styles */
        @media (max-width: 480px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 60px; /* Space for mobile menu button */
            }

            .page {
                padding: 10px 5px;
                margin: 0;
            }

            .container {
                padding: 15px;
                margin: 0;
                border-radius: 0;
            }

            .page-header h1 {
                font-size: 24px;
                margin-bottom: 15px;
                text-align: center;
            }

            .page-header p {
                font-size: 14px;
                text-align: center;
                margin-bottom: 20px;
            }

            /* Form input optimization */
            .asset-name-input, .asset-value-input {
                font-size: 16px !important; /* Prevent zoom on iOS */
                padding: 12px;
                width: 100%;
                margin: 5px 0;
                box-sizing: border-box;
            }

            /* Input grid optimization */
            .total-grid {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin: 15px 0;
            }

            .total-label-span {
                font-weight: bold;
                color: #ffffff;
            }

            .readonly-total-input {
                font-size: 16px;
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            /* Buttons */
            .btn {
                width: 100%;
                margin: 10px 0;
                padding: 12px;
                font-size: 16px;
                border-radius: 6px;
            }

            /* Chart container */
            #assetAllocationChart {
                height: 300px !important;
            }

            /* Asset/liability input groups */
            .input-row {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                background: #16213e;
            }

            /* Section headers */
            h3 {
                font-size: 18px;
                text-align: center;
                margin: 20px 0 15px 0;
            }
        }

        /* Tablet Styles */
        @media (max-width: 768px) and (min-width: 481px) {
            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .page {
                padding: 20px 15px;
            }

            .container {
                padding: 20px;
            }

            .asset-name-input, .asset-value-input {
                font-size: 16px;
                padding: 10px;
            }

            .total-grid {
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 15px;
                align-items: center;
            }
        }
    </style>
    <script src="file-saver.js"></script>
    <script src="user-manager.js"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">FIQuest</h1>
                <p class="user-info">Financial Independence Journey</p>
            </div>
            
            <div class="nav-menu">
                <a href="my-scenario.html" id="nav-scenarios">
                    <span class="nav-icon">📊</span>
                    My Scenario
                </a>
                <a href="net-worth-tracking.html" id="nav-net-worth-tracking">
                    <span class="nav-icon">📈</span>
                    Net Worth Tracking
                </a>
                <a href="data-management.html" id="nav-data-management">
                    <span class="nav-icon">💾</span>
                    Data Management
                </a>
                <!-- Collapsible Initial Setup Section -->
                <div class="nav-section">
                    <a href="#" class="nav-section-toggle" onclick="toggleInitialSetup(event)">
                        <span class="nav-icon">⚙️</span>
                        Initial Setup
                        <span class="toggle-arrow" id="setup-arrow">▼</span>
                    </a>
                    <div class="nav-subsection" id="initial-setup-section">
                        <a href="fi-calculator.html?access=intentional" id="nav-fi-calculator" class="nav-subitem">
                            <span class="nav-icon">🧮</span>
                            FI Calculator
                        </a>
                        <a href="net-worth.html" id="nav-net-worth" class="nav-subitem active">
                            <span class="nav-icon">💰</span>
                            Net Worth Setup
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="page">
                <div class="page-header">
                    <h1 class="page-title">Net Worth Setup</h1>
                    <p class="page-subtitle">Complete your initial net worth setup by inputting your additional assets and liabilities</p>
                </div>
                <div class="container">
                    <!-- Scenario Display -->
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px 0; color: #8B6914;">Selected FI Scenario</h3>
                        <p id="scenarioNameDisplay" style="margin: 0 0 5px 0; font-weight: bold; color: #1565c0;">Loading...</p>
                        <p id="setupDateDisplay" style="margin: 0; color: #666; font-size: 14px;">Setup Date: Loading...</p>
                    </div>

                    <!-- Assets Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #8B6914; border-bottom: 2px solid #D3AF37; padding-bottom: 10px; margin-bottom: 20px;">📈 Assets</h3>
                        
                        <!-- Investment Accounts from Scenario -->
                        <div style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #666;">Investment Accounts (from FI scenario)</h4>
                            <div id="investmentAccountsList"></div>
                            <div class="total-grid">
                                <span class="total-label-span">Total:</span>
                                <input type="text" id="totalInvestmentAccounts" readonly class="readonly-total-input">
                            </div>
                        </div>

                        <!-- Additional Assets -->
                        <div style="background: #1a1a2e; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: #666;">Additional Assets</h4>
                            <div id="additionalAssetsList">
                                <div class="asset-item item-grid">
                                    <input type="text" id="asset1Name" value="Cash" class="asset-name-input">
                                    <input type="text" id="asset1Value" value="2,000" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                                <div class="asset-item item-grid">
                                    <input type="text" id="asset2Name" value="Home" class="asset-name-input">
                                    <input type="text" id="asset2Value" value="700,000" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                                <div class="asset-item item-grid">
                                    <input type="text" id="asset3Name" value="Stock Options/RSUs" class="asset-name-input">
                                    <input type="text" id="asset3Value" value="10,000" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                                <div class="asset-item item-grid">
                                    <input type="text" id="asset4Name" value="Crypto" class="asset-name-input">
                                    <input type="text" id="asset4Value" value="4,000" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                                <div class="asset-item item-grid">
                                    <input type="text" id="asset5Name" value="Other" class="asset-name-input">
                                    <input type="text" id="asset5Value" value="1,000" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Liabilities Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #d32f2f; border-bottom: 2px solid #f44336; padding-bottom: 10px; margin-bottom: 20px;">📉 Liabilities</h3>
                        
                        <!-- Scenario Debts -->
                        <div style="background: #2a2a4a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #666;">Debts (from FI scenario)</h4>
                            <div id="scenarioDebtsList"></div>
                            <div class="total-grid">
                                <span class="total-label-span">Total:</span>
                                <input type="text" id="totalScenarioDebts" readonly class="readonly-total-input">
                            </div>
                        </div>

                        <!-- Additional Liabilities -->
                        <div style="background: #2a2a4a; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: #666;">Additional Liabilities</h4>
                            <div id="additionalLiabilitiesList">
                                <div class="liability-item item-grid">
                                    <input type="text" id="liability1Name" value="HELOC" class="asset-name-input">
                                    <input type="text" id="liability1Value" value="0" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                                <div class="liability-item item-grid">
                                    <input type="text" id="liability2Name" value="Other" class="asset-name-input">
                                    <input type="text" id="liability2Value" value="0" oninput="updateNetWorth()" class="asset-value-input">
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Net Worth Totals Summary -->
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <strong style="color: #8B6914;">Total Assets</strong><br>
                                <input type="text" id="totalAssets" readonly style="font-size: 18px; font-weight: bold; color: #8B6914; border: none; background: transparent; text-align: center; width: 100%;">
                            </div>
                            <div>
                                <strong style="color: #c62828;">Total Liabilities</strong><br>
                                <input type="text" id="totalLiabilities" readonly style="font-size: 18px; font-weight: bold; color: #c62828; border: none; background: transparent; text-align: center; width: 100%;">
                            </div>
                            <div>
                                <strong style="color: #1565c0;">Net Worth</strong><br>
                                <input type="text" id="currentNetWorth" readonly style="font-size: 20px; font-weight: bold; color: #1565c0; border: none; background: transparent; text-align: center; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Asset Allocation Chart -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #ffffff; border-bottom: 2px solid #0E0E55; padding-bottom: 10px; margin-bottom: 20px;">📊 Asset Allocation</h3>
                        <div style="background: #16213e; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="height: 400px; position: relative;">
                                <canvas id="assetAllocationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="scenario-controls">
                        <button class="calculate-btn" onclick="saveNetWorthSetup()">Save Net Worth Setup</button>
                        <button class="clear-btn" onclick="window.location.href='net-worth-tracking.html'">Next: Net Worth Tracking →</button>
                    </div>

                    <div class="disclaimer">
                        <h3>Disclaimer</h3>
                        <p>This material is provided for general informational purposes only and does not constitute financial, investment, tax, legal or accounting advice, it should not be relied upon in that regard or be considered predictive of any future market performance, nor does it constitute an offer or solicitation to buy or sell any securities referred to. Individual circumstances and current events are critical to sound investment planning; anyone wishing to act on this material should consult with their advisor. Before making any investment decisions, we encourage you to consider these and other factors carefully. Past performance may not be repeated and is not indicative of future results.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Net Worth Setup Functions
        let assetAllocationChart = null;

        function initializeNetWorthPage() {
            const activeScenario = JSON.parse(localStorage.getItem('fiquest_active_scenario') || 'null');
            
            if (activeScenario) {
                // Debug: Log the scenario structure to console
                console.log('Active Scenario Data:', activeScenario);
                console.log('Debts Data:', activeScenario.inputs?.debts);

                // Display selected scenario info
                document.getElementById('scenarioNameDisplay').textContent = activeScenario.name;

                // Check if setup already exists and display setup date
                const existingSetup = JSON.parse(localStorage.getItem('fiquest_net_worth_setup') || 'null');
                if (existingSetup && existingSetup.setupDate) {
                    document.getElementById('setupDateDisplay').textContent = `Setup Date: ${existingSetup.setupDate}`;
                } else {
                    document.getElementById('setupDateDisplay').textContent = 'Setup Date: Not yet saved';
                }
                
                // Populate investment accounts from scenario
                populateInvestmentAccounts(activeScenario);
                
                // Populate scenario debts
                populateScenarioDebts(activeScenario);
            } else {
                // No scenario selected - show default/empty state for testing
                document.getElementById('scenarioNameDisplay').textContent = 'No Scenario Selected (Demo Mode)';
                document.getElementById('setupDateDisplay').textContent = 'Setup Date: Demo Mode';

                // Populate with demo/default investment accounts
                populateDefaultInvestmentAccounts();

                // Populate with demo/default debts
                populateDefaultScenarioDebts();
            }
            
            // Initialize currency formatting for default values
            initializeNetWorthInputs();
            
            // Update calculations
            updateNetWorth();
        }

        function populateDefaultInvestmentAccounts() {
            const accountsList = document.getElementById('investmentAccountsList');
            let totalInvestment = 0;
            
            accountsList.innerHTML = '';
            
            // Default demo investment accounts for testing
            const defaultAccounts = [
                { name: 'RRSP1', value: 250000 },
                { name: 'RRSP2', value: 150000 },
                { name: 'TFSA1', value: 300000 },
                { name: 'TFSA2', value: 200000 },
                { name: 'Taxable Brokerage', value: 100000 }
            ];
            
            defaultAccounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = account.name;
                nameInput.readOnly = true;
                nameInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.value = '$' + formatNumber(account.value);
                valueInput.readOnly = true;
                valueInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                accountDiv.appendChild(nameInput);
                accountDiv.appendChild(valueInput);
                accountsList.appendChild(accountDiv);

                totalInvestment += account.value;
            });
            
            document.getElementById('totalInvestmentAccounts').value = '$' + formatNumber(totalInvestment);
        }

        function populateDefaultScenarioDebts() {
            const debtsList = document.getElementById('scenarioDebtsList');
            let totalDebt = 0;
            
            debtsList.innerHTML = '';
            
            // Only show debts if they exist in scenario data (no default demo debts)
            const scenario = JSON.parse(localStorage.getItem('fiquest_active_scenario'));
            const scenarioDebts = [];
            
            if (scenario && scenario.inputs && scenario.inputs.debts) {
                const debts = scenario.inputs.debts;
                if (debts.mortgage && debts.mortgage.balance > 0) {
                    scenarioDebts.push({ name: 'Mortgage', value: debts.mortgage.balance });
                }
                if (debts.vehicle && debts.vehicle.balance > 0) {
                    scenarioDebts.push({ name: 'Vehicle Loan', value: debts.vehicle.balance });
                }
                if (debts.other && debts.other.balance > 0) {
                    scenarioDebts.push({ name: 'Other Debt', value: debts.other.balance });
                }
            }
            
            if (scenarioDebts.length === 0) {
                // Show message when no debts exist
                const noDebtsDiv = document.createElement('div');
                noDebtsDiv.style.cssText = 'padding: 20px; text-align: center; color: #666; font-style: italic;';
                noDebtsDiv.textContent = 'No debts found in selected scenario';
                debtsList.appendChild(noDebtsDiv);
                
                document.getElementById('totalScenarioDebts').value = '$0';
                return;
            }
            
            scenarioDebts.forEach(debt => {
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = debt.name;
                nameSpan.style.color = '#666';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = '$' + formatNumber(debt.value);
                valueSpan.style.fontWeight = 'bold';
                
                debtDiv.appendChild(nameSpan);
                debtDiv.appendChild(valueSpan);
                debtsList.appendChild(debtDiv);
                
                totalDebt += debt.value;
            });
            
            document.getElementById('totalScenarioDebts').value = '$' + formatNumber(totalDebt);
        }

        function populateInvestmentAccounts(scenario) {
            const accountsList = document.getElementById('investmentAccountsList');
            let totalInvestment = 0;
            
            accountsList.innerHTML = '';
            
            if (scenario.inputs && scenario.inputs.accounts && scenario.inputs.accounts.length > 0) {
                // Use actual account data from scenario
                scenario.inputs.accounts.forEach(account => {
                    const accountDiv = document.createElement('div');
                    accountDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';

                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = account.name;
                    nameInput.readOnly = true;
                    nameInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                    const valueInput = document.createElement('input');
                    valueInput.type = 'text';
                    valueInput.value = '$' + formatNumber(account.value);
                    valueInput.readOnly = true;
                    valueInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                    accountDiv.appendChild(nameInput);
                    accountDiv.appendChild(valueInput);
                    accountsList.appendChild(accountDiv);

                    totalInvestment += account.value;
                });
            } else {
                // Fallback to defaults if no account data available
                populateDefaultInvestmentAccounts();
                return;
            }
            
            document.getElementById('totalInvestmentAccounts').value = '$' + formatNumber(totalInvestment);
        }

        function populateScenarioDebts(scenario) {
            const debtsList = document.getElementById('scenarioDebtsList');
            let totalDebt = 0;
            
            debtsList.innerHTML = '';
            
            // Debug logging
            console.log('populateScenarioDebts called with:', scenario);
            console.log('Debts object:', scenario.inputs?.debts);
            
            // Check mortgage from scenario data
            if (scenario.inputs?.debts?.mortgage && scenario.inputs.debts.mortgage.balance > 0) {
                const mortgageBalance = scenario.inputs.debts.mortgage.balance;
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = 'Mortgage';
                nameInput.readOnly = true;
                nameInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.value = '$' + formatNumber(mortgageBalance);
                valueInput.readOnly = true;
                valueInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                debtDiv.appendChild(nameInput);
                debtDiv.appendChild(valueInput);
                debtsList.appendChild(debtDiv);

                totalDebt += mortgageBalance;
            }
            
            // Check vehicle loan from scenario data
            if (scenario.inputs?.debts?.vehicle && scenario.inputs.debts.vehicle.balance > 0) {
                const vehicleBalance = scenario.inputs.debts.vehicle.balance;
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = 'Vehicle Loan';
                nameInput.readOnly = true;
                nameInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.value = '$' + formatNumber(vehicleBalance);
                valueInput.readOnly = true;
                valueInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                debtDiv.appendChild(nameInput);
                debtDiv.appendChild(valueInput);
                debtsList.appendChild(debtDiv);

                totalDebt += vehicleBalance;
            }

            // Check other debt from scenario data
            if (scenario.inputs?.debts?.other && scenario.inputs.debts.other.balance > 0) {
                const otherBalance = scenario.inputs.debts.other.balance;
                const debtDiv = document.createElement('div');
                debtDiv.style.cssText = 'display: grid; grid-template-columns: 150px 150px; gap: 10px; margin-bottom: 8px; align-items: center;';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = 'Other Debt';
                nameInput.readOnly = true;
                nameInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.value = '$' + formatNumber(otherBalance);
                valueInput.readOnly = true;
                valueInput.style.cssText = 'border: 1px solid #e9ecef; padding: 5px; border-radius: 6px; background: #1a1a2e; color: #6c757d; cursor: not-allowed; font-weight: 400; font-size: 14px;';

                debtDiv.appendChild(nameInput);
                debtDiv.appendChild(valueInput);
                debtsList.appendChild(debtDiv);

                totalDebt += otherBalance;
            }
            
            // If no debts found, show a message
            if (totalDebt === 0) {
                const noDebtsDiv = document.createElement('div');
                noDebtsDiv.style.cssText = 'color: #666; font-style: italic; text-align: center; padding: 10px;';
                noDebtsDiv.textContent = 'No debts from FI scenario';
                debtsList.appendChild(noDebtsDiv);
            }
            
            document.getElementById('totalScenarioDebts').value = '$' + formatNumber(totalDebt);
        }

        function initializeNetWorthInputs() {
            // Format currency inputs for additional assets
            const assetInputs = ['asset1Value', 'asset2Value', 'asset3Value', 'asset4Value', 'asset5Value'];
            assetInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    formatCurrencyInput(element);
                }
            });
            
            // Format currency inputs for additional liabilities
            const liabilityInputs = ['liability1Value', 'liability2Value'];
            liabilityInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    formatCurrencyInput(element);
                }
            });
        }

        function updateNetWorth() {
            // Calculate total assets
            let totalAssets = 0;
            
            // Add investment accounts total
            const investmentTotal = unformatNumber(document.getElementById('totalInvestmentAccounts').value.replace('$', ''));
            totalAssets += investmentTotal;
            
            // Add additional assets
            for (let i = 1; i <= 5; i++) {
                const assetValue = unformatNumber(document.getElementById(`asset${i}Value`).value);
                totalAssets += assetValue;
            }
            
            // Calculate total liabilities
            let totalLiabilities = 0;
            
            // Add scenario debts total
            const scenarioDebtsTotal = unformatNumber(document.getElementById('totalScenarioDebts').value.replace('$', ''));
            totalLiabilities += scenarioDebtsTotal;
            
            // Add additional liabilities
            for (let i = 1; i <= 2; i++) {
                const liabilityValue = unformatNumber(document.getElementById(`liability${i}Value`).value);
                totalLiabilities += liabilityValue;
            }
            
            // Update displays
            document.getElementById('totalAssets').value = '$' + formatNumber(totalAssets);
            document.getElementById('totalLiabilities').value = '$' + formatNumber(totalLiabilities);
            
            const netWorth = totalAssets - totalLiabilities;
            document.getElementById('currentNetWorth').value = '$' + formatNumber(netWorth);
            
            // Update asset allocation chart
            updateAssetAllocationChart(totalAssets);
        }

        function updateAssetAllocationChart(totalAssets) {
            const ctx = document.getElementById('assetAllocationChart').getContext('2d');
            
            if (assetAllocationChart) {
                assetAllocationChart.destroy();
            }
            
            // Gather data for chart
            const data = [];
            const labels = [];
            const colors = ['#D3AF37', '#2196F3', '#FF9800', '#9C27B0', '#607D8B', '#795548', '#E91E63', '#00BCD4'];
            
            // Investment accounts (combined as "Stocks")
            const investmentTotal = unformatNumber(document.getElementById('totalInvestmentAccounts').value.replace('$', ''));
            if (investmentTotal > 0) {
                data.push(((investmentTotal / totalAssets) * 100).toFixed(1));
                labels.push('Stocks');
            }
            
            // Additional assets
            for (let i = 1; i <= 5; i++) {
                const assetValue = unformatNumber(document.getElementById(`asset${i}Value`).value);
                const assetName = document.getElementById(`asset${i}Name`).value;
                
                if (assetValue > 0) {
                    data.push(((assetValue / totalAssets) * 100).toFixed(1));
                    labels.push(assetName);
                }
            }
            
            assetAllocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function saveNetWorthSetup() {
            const currentDate = new Date();
            const scenario = JSON.parse(localStorage.getItem('fiquest_active_scenario'));
            
            // Capture individual investment accounts
            const investmentAccountsArray = [];
            if (scenario && scenario.inputs && scenario.inputs.accounts) {
                // Use actual account data from scenario
                scenario.inputs.accounts.forEach(account => {
                    investmentAccountsArray.push({
                        name: account.name,
                        value: account.value
                    });
                });
            } else {
                // Use default accounts if no scenario accounts available
                const defaultAccounts = [
                    { name: 'RRSP1', value: 250000 },
                    { name: 'RRSP2', value: 150000 },
                    { name: 'TFSA1', value: 300000 },
                    { name: 'TFSA2', value: 200000 },
                    { name: 'Taxable Brokerage', value: 100000 }
                ];
                investmentAccountsArray.push(...defaultAccounts);
            }
            
            // Capture individual scenario debts  
            const scenarioDebtsArray = [];
            if (scenario && scenario.inputs && scenario.inputs.debts) {
                // Extract individual debt types from scenario structure
                const debts = scenario.inputs.debts;
                
                if (debts.mortgage && debts.mortgage.balance > 0) {
                    scenarioDebtsArray.push({
                        name: 'Mortgage',
                        value: debts.mortgage.balance
                    });
                }
                
                if (debts.vehicle && debts.vehicle.balance > 0) {
                    scenarioDebtsArray.push({
                        name: 'Vehicle Loan',
                        value: debts.vehicle.balance
                    });
                }
                
                if (debts.other && debts.other.balance > 0) {
                    scenarioDebtsArray.push({
                        name: 'Other Debt',
                        value: debts.other.balance
                    });
                }
                
                // Only use debts if they actually exist (no defaults)
                console.log('Scenario debts found:', scenarioDebtsArray.length);
            } else {
                console.log('No scenario debt data available - will save empty debt array');
            }

            const netWorthData = {
                timestamp: currentDate.toISOString(),
                setupDate: currentDate.getFullYear() + '-' +
                           String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                           String(currentDate.getDate()).padStart(2, '0'), // Local YYYY-MM-DD format
                setupYear: currentDate.getFullYear(),
                scenario: scenario,
                assets: {
                    investmentAccounts: investmentAccountsArray,
                    additionalAssets: {}
                },
                liabilities: {
                    scenarioDebts: scenarioDebtsArray,
                    additionalLiabilities: {}
                },
                totals: {
                    totalAssets: parseFloat(document.getElementById('totalAssets').value.replace(/[$,]/g, '')),
                    totalLiabilities: parseFloat(document.getElementById('totalLiabilities').value.replace(/[$,]/g, '')),
                    netWorth: parseFloat(document.getElementById('currentNetWorth').value.replace(/[$,]/g, ''))
                }
            };
            
            // Capture additional asset data with names and values
            for (let i = 1; i <= 5; i++) {
                const name = document.getElementById(`asset${i}Name`).value;
                const value = parseFloat(document.getElementById(`asset${i}Value`).value.replace(/[$,]/g, '')) || 0;
                if (name && name.trim() !== '') {
                    netWorthData.assets.additionalAssets[name] = value;
                }
            }
            
            // Capture additional liability data with names and values
            for (let i = 1; i <= 2; i++) {
                const name = document.getElementById(`liability${i}Name`).value;
                const value = parseFloat(document.getElementById(`liability${i}Value`).value.replace(/[$,]/g, '')) || 0;
                if (name && name.trim() !== '') {
                    netWorthData.liabilities.additionalLiabilities[name] = value;
                }
            }
            
            // Save comprehensive data for use across all app pages
            localStorage.setItem('fiquest_net_worth_setup', JSON.stringify(netWorthData));
            
            // Also save a simplified version for easy access by other pages
            const simplifiedData = {
                timestamp: netWorthData.timestamp,
                netWorth: netWorthData.totals.netWorth,
                totalAssets: netWorthData.totals.totalAssets,
                totalLiabilities: netWorthData.totals.totalLiabilities
            };
            localStorage.setItem('fiquest_current_net_worth', JSON.stringify(simplifiedData));
            
            console.log('Saved net worth setup with individual accounts:', netWorthData);

            // Prompt user to update save file
            const shouldExportSave = confirm(
                '✅ Net Worth Setup saved successfully!\n\n' +
                '💾 SAVE FILE RECOMMENDATION:\n' +
                'Would you like to update your save file with this important progress?\n\n' +
                'This ensures your net worth setup is backed up and available if you need to reload your game later.'
            );

            if (shouldExportSave) {
                // Debug logging
                console.log('userManager available:', !!userManager);
                console.log('currentPlayer available:', !!(userManager && userManager.currentPlayer));

                if (!userManager) {
                    alert('⚠️ UserManager not available. Please refresh the page and try again.\nNet worth setup was saved successfully.');
                    return;
                }

                if (!userManager.currentPlayer) {
                    alert('⚠️ No player logged in. Please refresh the page and try again.\nNet worth setup was saved successfully.');
                    return;
                }

                try {
                    // Create updated save file
                    console.log('Attempting to export data...');
                    const exportData = userManager.exportAllUserData();
                    console.log('Export data generated, length:', exportData.length);

                    const filename = CrossBrowserFileSaver.generateFilename(userManager.currentPlayer.playerName, true);
                    console.log('Generated filename:', filename);

                    CrossBrowserFileSaver.saveAs(exportData, filename, 'application/json');
                    console.log('Save file created successfully');

                    alert('✅ Save file updated successfully!\n\nYour net worth setup has been backed up to: ' + filename);
                } catch (error) {
                    console.error('Error updating save file:', error);
                    console.error('Error details:', error.message, error.stack);
                    alert('⚠️ Net worth setup saved, but save file update failed.\n\nError: ' + error.message + '\n\nYou can manually update your save file from the Data Management page.');
                }
            } else {
                alert('Net Worth Setup saved successfully! All data is now available across the FIQuest app.\n\n💡 Remember to update your save file later from the Data Management page.');
            }
        }

        // Utility functions
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function unformatNumber(str) {
            return parseFloat(str.replace(/[$,]/g, '')) || 0;
        }

        function formatCurrencyInput(input) {
            input.addEventListener('input', function() {
                let value = this.value.replace(/[$,]/g, '');
                if (!isNaN(value) && value !== '') {
                    this.value = formatNumber(value);
                }
            });
            
            // Format initial value
            let initialValue = input.value.replace(/[$,]/g, '');
            if (!isNaN(initialValue) && initialValue !== '') {
                input.value = formatNumber(initialValue);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in - redirect to start if not
            if (!userManager.requireLogin()) {
                return;
            }
            
            // Add player info to UI
            userManager.addPlayerInfoToUI();
            
            initializeNetWorthPage();
            
            // Expand Initial Setup section by default since this is Net Worth Setup
            const setupSection = document.getElementById('initial-setup-section');
            const setupArrow = document.getElementById('setup-arrow');
            if (setupSection && setupArrow) {
                setupSection.style.display = 'block';
                setupArrow.classList.add('expanded');
            }
        });

        // Toggle Initial Setup section
        function toggleInitialSetup(event) {
            event.preventDefault();
            
            const section = document.getElementById('initial-setup-section');
            const arrow = document.getElementById('setup-arrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }
    </script>
</body>
</html>