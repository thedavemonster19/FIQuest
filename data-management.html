<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management - FIQuest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
            color: #333;
            background: #f8f9fa;
        }

        /* Typography System */
        h1, .text-xl { font-size: 28px; font-weight: 300; line-height: 1.2; }
        h2, .text-lg { font-size: 24px; font-weight: 500; line-height: 1.3; }
        h3, .text-md { font-size: 18px; font-weight: 500; line-height: 1.4; }
        h4, .text-sm { font-size: 16px; font-weight: 500; line-height: 1.4; }
        .text-xs { font-size: 14px; font-weight: 400; line-height: 1.4; }
        .text-micro { font-size: 12px; font-weight: 400; line-height: 1.3; }

        .app-container {
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: white;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 16px;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-menu a.active {
            background: rgba(255,255,255,0.2);
            font-weight: bold;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* White dot behavior matching My Scenario page */
        #logoutBtn::before {
            content: '•';
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-right: 8px;
            opacity: 0.9;
        }

        #logoutBtn:hover::before {
            opacity: 0;
        }

        /* Fix logout button alignment to match other pages */
        #logoutBtn {
            padding-left: 5px !important;
        }




        /* Collapsible Navigation Styles */
        .nav-section {
            margin: 5px 0;
        }

        .nav-section-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-section-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .toggle-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .nav-subsection {
            background: rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-subitem {
            display: flex;
            align-items: center;
            padding: 10px 20px 10px 40px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-subitem:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            padding-left: 45px !important;
        }

        .nav-subitem.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: bold;
            border-right: 3px solid #fff;
        }

        .main-content {
            margin-left: 250px;
            padding: 0;
            min-height: 100vh;
        }

        .page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-title {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 300;
            line-height: 1.2;
        }

        .page-subtitle {
            color: #666;
            font-size: 16px;
            margin: 0;
            text-align: center;
            font-weight: 400;
            line-height: 1.4;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .privacy-notice {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #4CAF50;
        }

        .privacy-notice h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .privacy-notice p {
            color: #1b5e20;
            margin-bottom: 8px;
        }

        .data-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .data-info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .data-info-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .data-info-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-info-card .label {
            font-size: 14px;
            color: #666;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 15px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #e8f0fe;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .format-options {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .format-option input[type="radio"] {
            margin: 0;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .help-text {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .mobile-menu-btn:hover {
            background: #45a049;
        }

        /* Enhanced Mobile Styles */
        @media (max-width: 480px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-250px);
                transition: transform 0.3s ease;
                z-index: 1000;
                width: 250px;
                overflow: visible;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 60px; /* Space for mobile menu button */
            }

            .page {
                padding: 10px 5px;
                margin: 0;
            }

            .container {
                padding: 15px;
                margin: 0;
                border-radius: 0;
            }

            .page-header h1 {
                font-size: 24px;
                margin-bottom: 15px;
                text-align: center;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
                padding: 12px;
                font-size: 16px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">FIQuest</h1>
                <p class="user-info">Financial Independence Journey</p>
            </div>

            <div class="nav-menu">
                <a href="my-scenario.html" id="nav-scenarios">
                    <span class="nav-icon">📊</span>
                    My Scenario
                </a>
                <a href="net-worth-tracking.html" id="nav-net-worth-tracking">
                    <span class="nav-icon">📈</span>
                    Net Worth Tracking
                </a>
                <a href="data-management.html" id="nav-data-management" class="active">
                    <span class="nav-icon">💾</span>
                    Data Management
                </a>
                <!-- Collapsible Initial Setup Section -->
                <div class="nav-section">
                    <a href="#" class="nav-section-toggle" onclick="toggleInitialSetup(event)">
                        <span class="nav-icon">⚙️</span>
                        Initial Setup
                        <span class="toggle-arrow" id="setup-arrow">▼</span>
                    </a>
                    <div class="nav-subsection" id="initial-setup-section" style="display: none;">
                        <a href="fi-calculator.html?access=intentional" id="nav-fi-calculator" class="nav-subitem">
                            <span class="nav-icon">🧮</span>
                            FI Calculator
                        </a>
                        <a href="net-worth.html" id="nav-net-worth" class="nav-subitem">
                            <span class="nav-icon">💰</span>
                            Net Worth Setup
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="page">
                <div class="page-header">
                    <h1 class="page-title">Data Management</h1>
                    <p class="page-subtitle">Export, import, and manage your financial data</p>
                </div>

                <div class="privacy-notice">
                    <h3>🔒 Your Privacy is Protected</h3>
                    <p><strong>Your data never leaves your device.</strong> All calculations and storage happen locally in your browser.</p>
                    <p>Export files are created on your computer only - no data is transmitted to servers or third parties.</p>
                    <p>This ensures complete privacy and control over your sensitive financial information.</p>
                </div>

                <div class="container">
                    <!-- Data Overview Section -->
                    <div class="section">
                        <h2 class="section-title">
                            📊 Your Data Overview
                        </h2>

                        <div class="data-info-grid" id="dataInfoGrid">
                            <!-- Data cards will be populated by JavaScript -->
                        </div>

                        <div id="lastBackupInfo" class="help-text">
                            <!-- Last backup info will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="section">
                        <h2 class="section-title">
                            💾 Update Your Save File
                        </h2>
                        <p>Update your FIQuest save file with your latest progress and data.</p>
                        <div class="help-text"><strong>Important:</strong> In FIQuest's file-based system, you need to update your save file regularly to preserve your progress. Your save file is your only way to continue your game!</div>

                        <div class="format-options">
                            <div class="format-option">
                                <input type="radio" id="export-json" name="exportFormat" value="json" checked>
                                <label for="export-json">JSON (Complete Data)</label>
                            </div>
                            <div class="format-option">
                                <input type="radio" id="export-csv" name="exportFormat" value="csv">
                                <label for="export-csv">CSV (Spreadsheet Friendly)</label>
                            </div>
                        </div>

                        <div class="checkbox-option">
                            <input type="checkbox" id="export-encrypt">
                            <label for="export-encrypt">Encrypt export file (recommended for sensitive data)</label>
                        </div>
                        <div class="help-text">Encryption adds basic protection to your export file.</div>

                        <div class="button-group">
                            <button class="btn btn-primary" onclick="exportUserData()">
                                💾 Update Save File
                            </button>
                        </div>

                        <div class="progress-bar" id="exportProgress">
                            <div class="progress-bar-fill"></div>
                        </div>
                        <div class="status-message" id="exportStatus"></div>
                    </div>

                    <!-- Import Section -->
                    <div class="section">
                        <h2 class="section-title">
                            📥 Import Your Data
                        </h2>
                        <p>Restore your FIQuest data from a previously exported file.</p>
                        <div class="help-text">
                            <strong>⚠️ Warning:</strong> Importing will replace your current data.
                            We recommend exporting your current data first as a backup.
                        </div>

                        <div class="file-input-wrapper">
                            <input type="file" id="importFile" class="file-input" accept=".json,.csv,.txt" onchange="handleFileSelect(event)">
                            <label for="importFile" class="file-input-label">
                                📁 Choose File to Import
                            </label>
                        </div>

                        <div class="checkbox-option">
                            <input type="checkbox" id="import-encrypted">
                            <label for="import-encrypted">File is encrypted</label>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" id="importBtn" onclick="importUserData()" disabled>
                                📥 Import Data
                            </button>
                        </div>

                        <div class="progress-bar" id="importProgress">
                            <div class="progress-bar-fill"></div>
                        </div>
                        <div class="status-message" id="importStatus"></div>
                    </div>

                    <!-- Data Management Section -->
                    <div class="section">
                        <h2 class="section-title">
                            🛠️ Data Management
                        </h2>
                        <p>Advanced data management and troubleshooting tools.</p>

                        <div class="button-group">
                            <button class="btn btn-secondary" onclick="viewRawData()">
                                🔍 View Raw Data
                            </button>
                            <button class="btn btn-secondary" onclick="validateData()">
                                ✅ Validate Data Integrity
                            </button>
                            <button class="btn btn-danger" onclick="clearAllData()">
                                🗑️ Clear All Data
                            </button>
                        </div>

                        <div class="status-message" id="managementStatus"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Embedded UserManager functionality for data management
        class DateTimeUtils {
            static getUserLocalDate() {
                const now = new Date();
                return {
                    date: now.toLocaleDateString('en-US'),
                    time: now.toLocaleTimeString('en-US'),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    iso: now.toISOString(),
                    timestamp: now.getTime()
                };
            }

            static getFilenameDateFormat() {
                const now = new Date();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const year = String(now.getFullYear()).slice(-2);
                return `${month}${day}${year}`;
            }
        }

        class EmbeddedUserManager {
            constructor() {
                this.currentPlayer = null;
                this.init();
            }

            init() {
                const currentPlayerName = localStorage.getItem('fiquest_current_player');
                if (currentPlayerName) {
                    this.loadPlayer(currentPlayerName);
                }
            }

            loadPlayer(playerName) {
                try {
                    const playerData = localStorage.getItem(`fiquest_player_${playerName.toLowerCase()}`);
                    if (playerData) {
                        this.currentPlayer = JSON.parse(playerData);
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading player:', error);
                }
                return false;
            }

            getCurrentPlayer() {
                return this.currentPlayer;
            }

            isLoggedIn() {
                return this.currentPlayer !== null;
            }

            requireLogin() {
                if (!this.isLoggedIn()) {
                    window.location.href = 'index.html';
                    return false;
                }
                return true;
            }

            getStoredData(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.warn(`Error parsing stored data for ${key}:`, error);
                    return null;
                }
            }

            getNetWorthEntries() {
                if (!this.currentPlayer || !this.currentPlayer.gameData.netWorthTracking) {
                    return [];
                }
                return [...this.currentPlayer.gameData.netWorthTracking];
            }

            savePlayerData() {
                if (!this.currentPlayer) return;

                try {
                    const scenarios = localStorage.getItem('fiquest_scenarios');
                    const activeScenario = localStorage.getItem('fiquest_active_scenario');
                    const netWorthSetup = localStorage.getItem('fiquest_net_worth_setup');

                    this.currentPlayer.gameData = {
                        scenarios: scenarios ? JSON.parse(scenarios) : [],
                        activeScenario: activeScenario ? JSON.parse(activeScenario) : null,
                        netWorthSetup: netWorthSetup ? JSON.parse(netWorthSetup) : null,
                        netWorthTracking: this.currentPlayer.gameData.netWorthTracking || [],
                        preferences: this.currentPlayer.gameData.preferences || {
                            currency: 'USD',
                            dateFormat: 'MM/DD/YYYY'
                        }
                    };

                    const localDateTime = DateTimeUtils.getUserLocalDate();
                    this.currentPlayer.lastPlayedDate = localDateTime.iso;
                    this.currentPlayer.lastPlayedLocal = localDateTime.date;
                    this.currentPlayer.timezone = localDateTime.timezone;

                    localStorage.setItem(
                        `fiquest_player_${this.currentPlayer.playerName.toLowerCase()}`,
                        JSON.stringify(this.currentPlayer)
                    );

                    return true;
                } catch (error) {
                    console.error('Error saving player data:', error);
                    return false;
                }
            }

            exportAllUserData(format = 'json', includeEncryption = false) {
                if (!this.currentPlayer) {
                    throw new Error('No user logged in to export data');
                }

                try {
                    this.savePlayerData();

                    const exportData = {
                        version: '1.0.0',
                        exportDate: DateTimeUtils.getUserLocalDate().iso,
                        exportTimezone: DateTimeUtils.getUserLocalDate().timezone,
                        playerData: { ...this.currentPlayer },
                        gameData: {
                            scenarios: this.getStoredData('fiquest_scenarios'),
                            activeScenario: this.getStoredData('fiquest_active_scenario'),
                            netWorthSetup: this.getStoredData('fiquest_net_worth_setup'),
                            netWorthHistory: this.getStoredData('fiquest_net_worth_history'),
                            currentNetWorth: this.getStoredData('fiquest_current_net_worth')
                        },
                        metadata: {
                            exportedBy: 'FIQuest Web Application',
                            dataIntegrity: this.generateDataHash(),
                            playerName: this.currentPlayer.playerName,
                            lastPlayedDate: this.currentPlayer.lastPlayedDate
                        }
                    };

                    if (exportData.playerData.password) {
                        delete exportData.playerData.password;
                    }

                    if (format === 'json') {
                        const jsonData = JSON.stringify(exportData, null, 2);
                        return includeEncryption ? this.encryptData(jsonData) : jsonData;
                    } else if (format === 'csv') {
                        return this.convertCompleteDataToCSV(exportData);
                    } else {
                        throw new Error('Unsupported export format: ' + format);
                    }
                } catch (error) {
                    console.error('Error exporting user data:', error);
                    throw error;
                }
            }

            generateDataHash() {
                const dataString = JSON.stringify(this.currentPlayer);
                let hash = 0;
                for (let i = 0; i < dataString.length; i++) {
                    const char = dataString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }

            encryptData(data) {
                const encoded = btoa(data);
                let encrypted = '';
                const key = 'FIQuest2025';
                for (let i = 0; i < encoded.length; i++) {
                    encrypted += String.fromCharCode(
                        encoded.charCodeAt(i) ^ key.charCodeAt(i % key.length)
                    );
                }
                return btoa(encrypted);
            }

            decryptData(encryptedData) {
                try {
                    const encrypted = atob(encryptedData);
                    let decrypted = '';
                    const key = 'FIQuest2025';
                    for (let i = 0; i < encrypted.length; i++) {
                        decrypted += String.fromCharCode(
                            encrypted.charCodeAt(i) ^ key.charCodeAt(i % key.length)
                        );
                    }
                    return atob(decrypted);
                } catch (error) {
                    throw new Error('Failed to decrypt data - invalid encryption or corrupted file');
                }
            }

            convertCompleteDataToCSV(exportData) {
                let csv = '';

                // Header and Export Information
                csv += '"FIQuest Complete Data Export"\n';
                csv += `"Export Date: ${exportData.exportDate}"\n`;
                csv += `"Data Version: ${exportData.version}"\n`;
                csv += `"Export Timezone: ${exportData.exportTimezone}"\n\n`;

                // Player Profile Information
                csv += '"=== PLAYER PROFILE ==="\n';
                csv += '"Field","Value"\n';
                csv += `"Player Name","${exportData.playerData.playerName}"\n`;
                csv += `"Player Email","${exportData.playerData.email || 'Not provided'}"\n`;
                csv += `"Date Created","${exportData.playerData.dateCreated || 'Unknown'}"\n`;
                csv += `"Last Played Date","${exportData.playerData.lastPlayedDate}"\n`;
                csv += `"Last Played Local","${exportData.playerData.lastPlayedLocal || 'Unknown'}"\n`;
                csv += `"Player Timezone","${exportData.playerData.timezone || 'Unknown'}"\n`;
                csv += `"Character Type","${exportData.playerData.characterType || 'Default'}"\n`;
                csv += `"Data Integrity Hash","${exportData.metadata.dataIntegrity}"\n\n`;

                // Financial Independence Scenarios - Detailed
                if (exportData.gameData.scenarios && exportData.gameData.scenarios.length > 0) {
                    csv += '"=== FINANCIAL INDEPENDENCE SCENARIOS ==="\n';
                    csv += '"Scenario Name","Initial Age","Active Until Age","Life Expectancy","Starting Capital","Annual Contributions","Annual Active Spending","Annual Inactive Spending","Rate of Return %","Inflation Rate %","Withdrawal Rate %","Target Amount","FI Year","Final Portfolio Value","Monthly Savings Required","Created Date","Last Modified"\n';

                    exportData.gameData.scenarios.forEach(scenario => {
                        csv += `"${scenario.name || 'Unnamed Scenario'}",`;
                        csv += `"${scenario.initialAge || 'N/A'}",`;
                        csv += `"${scenario.activeUntilAge || 'N/A'}",`;
                        csv += `"${scenario.lifeExpectancy || 'N/A'}",`;
                        csv += `"${scenario.startingCapital || 0}",`;
                        csv += `"${scenario.annualContributions || 0}",`;
                        csv += `"${scenario.annualActiveSpending || 0}",`;
                        csv += `"${scenario.annualInactiveSpending || scenario.annualSpending || 0}",`;
                        csv += `"${scenario.rateOfReturn || 7}",`;
                        csv += `"${scenario.inflationRate || 2}",`;
                        csv += `"${scenario.withdrawalRate || 4}",`;
                        csv += `"${scenario.targetAmount || 0}",`;
                        csv += `"${scenario.fiYear || 'Not Calculated'}",`;
                        csv += `"${scenario.finalPortfolioValue || 'Not Calculated'}",`;
                        csv += `"${scenario.monthlySavingsRequired || 'Not Calculated'}",`;
                        csv += `"${scenario.dateCreated || 'Unknown'}",`;
                        csv += `"${scenario.lastModified || 'Unknown'}"\n`;
                    });

                    // Investment Account Details for Scenarios
                    csv += '\n"=== INVESTMENT ACCOUNT DETAILS ==="\n';
                    csv += '"Scenario Name","Account Name","Annual Contribution","Growth Rate %","Account Type","Notes"\n';

                    exportData.gameData.scenarios.forEach(scenario => {
                        if (scenario.investmentAccounts) {
                            Object.entries(scenario.investmentAccounts).forEach(([accountName, accountData]) => {
                                csv += `"${scenario.name || 'Unnamed'}","${accountName}","${accountData.annualContribution || 0}","${accountData.growthRate || scenario.rateOfReturn || 7}","${accountData.accountType || 'Investment'}","${accountData.notes || ''}"\n`;
                            });
                        }
                    });

                    // Debt Information for Scenarios
                    csv += '\n"=== DEBT DETAILS ==="\n';
                    csv += '"Scenario Name","Debt Type","Outstanding Balance","Interest Rate %","Monthly Payment","Additional Principal","Affects Contributions","Payoff Year"\n';

                    exportData.gameData.scenarios.forEach(scenario => {
                        if (scenario.debts) {
                            Object.entries(scenario.debts).forEach(([debtType, debtData]) => {
                                csv += `"${scenario.name || 'Unnamed'}","${debtType}","${debtData.outstandingBalance || 0}","${debtData.interestRate || 0}","${debtData.monthlyPayment || 0}","${debtData.additionalPrincipal || 0}","${debtData.affectContributions ? 'Yes' : 'No'}","${debtData.payoffYear || 'Not Calculated'}"\n`;
                            });
                        }
                    });

                    csv += '\n';
                }

                // Net Worth Setup Configuration
                if (exportData.gameData.netWorthSetup) {
                    csv += '"=== NET WORTH SETUP CONFIGURATION ==="\n';
                    csv += '"Category","Account Name","Account Type","Initial Value","Growth Rate %","Notes"\n';

                    const setup = exportData.gameData.netWorthSetup;

                    // Assets
                    if (setup.assetCategories) {
                        Object.entries(setup.assetCategories).forEach(([categoryName, accounts]) => {
                            if (typeof accounts === 'object') {
                                Object.entries(accounts).forEach(([accountName, accountData]) => {
                                    csv += `"${categoryName}","${accountName}","Asset","${accountData.initialValue || 0}","${accountData.growthRate || 0}","${accountData.notes || ''}"\n`;
                                });
                            }
                        });
                    }

                    // Liabilities
                    if (setup.liabilityCategories) {
                        Object.entries(setup.liabilityCategories).forEach(([categoryName, accounts]) => {
                            if (typeof accounts === 'object') {
                                Object.entries(accounts).forEach(([accountName, accountData]) => {
                                    csv += `"${categoryName}","${accountName}","Liability","${accountData.initialValue || 0}","${accountData.interestRate || 0}","${accountData.notes || ''}"\n`;
                                });
                            }
                        });
                    }

                    csv += '\n';
                }

                // Net Worth Tracking History with Account Details
                if (exportData.playerData.gameData && exportData.playerData.gameData.netWorthTracking) {
                    csv += '"=== NET WORTH TRACKING HISTORY ==="\n';
                    csv += '"Entry Date","Date Created","Total Assets","Total Liabilities","Net Worth","Projected Net Worth","Net Variance","Asset Variance","Liability Variance","Entry Notes","Entry ID"\n';

                    exportData.playerData.gameData.netWorthTracking.forEach(entry => {
                        csv += `"${entry.date}","${entry.dateCreated || 'Unknown'}","${entry.totals.totalAssets}","${entry.totals.totalLiabilities}","${entry.totals.netWorth}","${entry.totals.projectedNetWorth || 0}","${entry.totals.netVariance || 0}","${entry.totals.assetVariance || 0}","${entry.totals.liabilityVariance || 0}","${entry.notes || ''}","${entry.id || 'Unknown'}"\n`;
                    });

                    // Individual Account Values for each Net Worth Entry
                    csv += '\n"=== INDIVIDUAL ACCOUNT VALUES ==="\n';
                    csv += '"Entry Date","Account Category","Account Name","Account Type","Actual Value","Projected Value","Variance","Entry ID"\n';

                    exportData.playerData.gameData.netWorthTracking.forEach(entry => {
                        // Asset accounts
                        if (entry.accounts && entry.accounts.assets) {
                            Object.entries(entry.accounts.assets).forEach(([accountName, accountData]) => {
                                const category = accountData.category || 'Unknown Category';
                                csv += `"${entry.date}","${category}","${accountName}","Asset","${accountData.actual || 0}","${accountData.projected || 0}","${accountData.variance || 0}","${entry.id || 'Unknown'}"\n`;
                            });
                        }

                        // Liability accounts
                        if (entry.accounts && entry.accounts.liabilities) {
                            Object.entries(entry.accounts.liabilities).forEach(([accountName, accountData]) => {
                                const category = accountData.category || 'Unknown Category';
                                csv += `"${entry.date}","${category}","${accountName}","Liability","${accountData.actual || 0}","${accountData.projected || 0}","${accountData.variance || 0}","${entry.id || 'Unknown'}"\n`;
                            });
                        }
                    });

                    csv += '\n';
                }

                // Active Scenario Information
                if (exportData.gameData.activeScenario) {
                    csv += '"=== ACTIVE SCENARIO ==="\n';
                    csv += '"Field","Value"\n';
                    csv += `"Active Scenario Name","${exportData.gameData.activeScenario.name || 'Unnamed'}"\n`;
                    csv += `"Selected Date","${exportData.gameData.activeScenario.selectedDate || 'Unknown'}"\n`;
                    csv += `"Setup Year","${exportData.gameData.activeScenario.setupYear || 'Unknown'}"\n`;
                    csv += `"Current Year","${new Date().getFullYear()}"\n\n`;
                }

                // User Preferences
                if (exportData.playerData.gameData && exportData.playerData.gameData.preferences) {
                    csv += '"=== USER PREFERENCES ==="\n';
                    csv += '"Setting","Value"\n';
                    const prefs = exportData.playerData.gameData.preferences;
                    Object.entries(prefs).forEach(([setting, value]) => {
                        csv += `"${setting}","${value}"\n`;
                    });
                    csv += '\n';
                }

                // Data Statistics
                csv += '"=== DATA STATISTICS ==="\n';
                csv += '"Metric","Count"\n';
                csv += `"Total Scenarios","${exportData.gameData.scenarios ? exportData.gameData.scenarios.length : 0}"\n`;
                csv += `"Net Worth Entries","${exportData.playerData.gameData && exportData.playerData.gameData.netWorthTracking ? exportData.playerData.gameData.netWorthTracking.length : 0}"\n`;
                csv += `"Export File Size (chars)","${JSON.stringify(exportData).length}"\n`;
                csv += `"Player Data Size (chars)","${JSON.stringify(exportData.playerData).length}"\n`;
                csv += `"Game Data Size (chars)","${JSON.stringify(exportData.gameData).length}"\n\n`;

                // Footer
                csv += '"=== END OF EXPORT ==="\n';
                csv += `"Generated by FIQuest Data Management System on ${exportData.exportDate}"\n`;
                csv += '"For data import, use the JSON format for full compatibility"\n';

                return csv;
            }

            importAllUserData(importData, isEncrypted = false) {
                try {
                    let parsedData;
                    if (isEncrypted) {
                        const decryptedData = this.decryptData(importData);
                        parsedData = JSON.parse(decryptedData);
                    } else {
                        parsedData = typeof importData === 'string' ? JSON.parse(importData) : importData;
                    }

                    if (!this.validateImportData(parsedData)) {
                        throw new Error('Invalid import data format');
                    }

                    const backupData = this.exportAllUserData();
                    const backupKey = `fiquest_backup_${Date.now()}`;
                    localStorage.setItem(backupKey, backupData);

                    try {
                        this.currentPlayer = { ...parsedData.playerData };

                        if (parsedData.gameData.scenarios) {
                            localStorage.setItem('fiquest_scenarios', JSON.stringify(parsedData.gameData.scenarios));
                        }
                        if (parsedData.gameData.activeScenario) {
                            localStorage.setItem('fiquest_active_scenario', JSON.stringify(parsedData.gameData.activeScenario));
                        }
                        if (parsedData.gameData.netWorthSetup) {
                            localStorage.setItem('fiquest_net_worth_setup', JSON.stringify(parsedData.gameData.netWorthSetup));
                        }
                        if (parsedData.gameData.netWorthHistory) {
                            localStorage.setItem('fiquest_net_worth_history', JSON.stringify(parsedData.gameData.netWorthHistory));
                        }
                        if (parsedData.gameData.currentNetWorth) {
                            localStorage.setItem('fiquest_current_net_worth', JSON.stringify(parsedData.gameData.currentNetWorth));
                        }

                        localStorage.setItem(
                            `fiquest_player_${this.currentPlayer.playerName.toLowerCase()}`,
                            JSON.stringify(this.currentPlayer)
                        );
                        localStorage.setItem('fiquest_current_player', this.currentPlayer.playerName);

                        localStorage.removeItem(backupKey);

                        return {
                            success: true,
                            message: 'Data imported successfully',
                            playerName: this.currentPlayer.playerName,
                            importDate: parsedData.exportDate
                        };

                    } catch (importError) {
                        localStorage.setItem(backupKey.replace('backup_', 'restore_'), backupData);
                        throw importError;
                    }

                } catch (error) {
                    console.error('Error importing user data:', error);
                    return {
                        success: false,
                        message: error.message || 'Unknown import error occurred'
                    };
                }
            }

            validateImportData(data) {
                if (!data || typeof data !== 'object') return false;
                if (!data.version || !data.playerData) return false;
                if (!data.playerData.playerName) return false;

                const supportedVersions = ['1.0.0'];
                if (!supportedVersions.includes(data.version)) {
                    console.warn('Import data version may not be fully compatible:', data.version);
                }

                return true;
            }

            downloadExportFile(data, filename, format = 'json') {
                const mimeTypes = {
                    'json': 'application/json',
                    'csv': 'text/csv',
                    'txt': 'text/plain'
                };

                const blob = new Blob([data], { type: mimeTypes[format] || 'text/plain' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            generateExportFilename(format = 'json', includeEncryption = false) {
                const date = DateTimeUtils.getFilenameDateFormat();
                const playerName = this.currentPlayer.playerName.toLowerCase().replace(/[^a-z0-9]/g, '');
                const encryptSuffix = includeEncryption ? '_encrypted' : '';
                return `fiquest_${playerName}_${date}${encryptSuffix}.${format}`;
            }

            getDataManagementInfo() {
                if (!this.currentPlayer) return null;

                const scenarios = this.getStoredData('fiquest_scenarios') || [];
                const netWorthEntries = this.getNetWorthEntries();

                const playerDataSize = JSON.stringify(this.currentPlayer).length;
                const gameDataSize = JSON.stringify({
                    scenarios: scenarios,
                    netWorth: netWorthEntries
                }).length;

                return {
                    playerName: this.currentPlayer.playerName,
                    lastPlayed: this.currentPlayer.lastPlayedDate,
                    dataSize: {
                        player: Math.round(playerDataSize / 1024 * 100) / 100,
                        game: Math.round(gameDataSize / 1024 * 100) / 100,
                        total: Math.round((playerDataSize + gameDataSize) / 1024 * 100) / 100
                    },
                    counts: {
                        scenarios: scenarios.length,
                        netWorthEntries: netWorthEntries.length
                    },
                    hasSetup: this.hasCompletedInitialSetup()
                };
            }

            hasCompletedInitialSetup() {
                if (!this.currentPlayer) return false;

                if (this.currentPlayer.gameData && this.currentPlayer.gameData.netWorthSetup) {
                    return true;
                }

                const savedSetup = localStorage.getItem('fiquest_net_worth_setup');
                return savedSetup && savedSetup !== 'null';
            }

            addPlayerInfoToUI() {
                if (!this.currentPlayer) return;

                // Add player info to sidebar
                const playerInfo = document.querySelector('.user-info');
                if (playerInfo) {
                    playerInfo.innerHTML = `Player: ${this.currentPlayer.playerName}`;
                }

                // Add logout button if not present
                this.addLogoutButton();
            }

            addLogoutButton() {
                // Check if logout button already exists
                if (document.getElementById('logoutBtn')) return;

                const sidebar = document.querySelector('.nav-menu');
                if (sidebar) {
                    // Create logout button exactly like the regular UserManager does
                    const logoutLink = document.createElement('a');
                    logoutLink.href = '#';
                    logoutLink.id = 'logoutBtn';
                    logoutLink.onclick = (e) => {
                        e.preventDefault();
                        this.logout();
                        return false;
                    };
                    // Use exact same structure as regular UserManager: nav-icon class to match other menu items
                    logoutLink.innerHTML = `
                        <span class="nav-icon">🚪</span>Logout
                    `;

                    // Don't add custom styling - let it inherit the same styles as other nav links
                    sidebar.appendChild(logoutLink);
                }
            }

            logout() {
                const shouldExport = confirm(
                    `🚨 LOGOUT WARNING 🚨\n\n` +
                    `Logging out will clear ALL data from this browser.\n` +
                    `To continue playing later, you'll need to import your save file.\n\n` +
                    `Would you like to create/update your save file before logging out?`
                );

                if (shouldExport && this.currentPlayer) {
                    try {
                        // Create and download save file
                        const exportData = this.exportAllUserData();
                        const filename = `fiquest_${this.currentPlayer.playerName.toLowerCase().replace(/[^a-z0-9]/g, '')}_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.json`;

                        // Use the embedded file download function
                        this.downloadExportFile(exportData, filename, 'json');

                        // Clear data after a short delay to allow download
                        setTimeout(() => {
                            this.clearAllData();
                        }, 1000);
                    } catch (error) {
                        console.error('Error creating save file:', error);
                        alert('Error creating save file. Logging out anyway.');
                        this.clearAllData();
                    }
                } else {
                    this.clearAllData();
                }
            }

            clearAllData() {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('fiquest_')) {
                        localStorage.removeItem(key);
                    }
                });
                alert('✅ Logged out successfully!\n\nAll data has been cleared from this browser.\nTo continue playing, you\'ll need to import your save file.');
                window.location.href = 'index.html';
            }
        }

        // Create global instance for compatibility
        const userManager = new EmbeddedUserManager();

        // Global variables
        let selectedFile = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Require user login
            if (!userManager.requireLogin()) {
                return;
            }

            // Add player info to UI
            userManager.addPlayerInfoToUI();

            // Load data overview
            loadDataOverview();
        });

        function loadDataOverview() {
            const dataInfo = userManager.getDataManagementInfo();

            if (!dataInfo) {
                document.getElementById('dataInfoGrid').innerHTML = '<p>No user data available.</p>';
                return;
            }

            const grid = document.getElementById('dataInfoGrid');
            grid.innerHTML = `
                <div class="data-info-card">
                    <h4>Player Profile</h4>
                    <div class="value">${dataInfo.playerName}</div>
                    <div class="label">Active Player</div>
                </div>
                <div class="data-info-card">
                    <h4>Data Size</h4>
                    <div class="value">${dataInfo.dataSize.total} KB</div>
                    <div class="label">Total Storage Used</div>
                </div>
                <div class="data-info-card">
                    <h4>Scenarios</h4>
                    <div class="value">${dataInfo.counts.scenarios}</div>
                    <div class="label">FI Scenarios Created</div>
                </div>
                <div class="data-info-card">
                    <h4>Net Worth Entries</h4>
                    <div class="value">${dataInfo.counts.netWorthEntries}</div>
                    <div class="label">Tracking Entries</div>
                </div>
            `;

            // Update last played info
            const lastBackupInfo = document.getElementById('lastBackupInfo');
            const lastPlayed = new Date(dataInfo.lastPlayed);
            lastBackupInfo.innerHTML = `Last activity: ${lastPlayed.toLocaleDateString()} at ${lastPlayed.toLocaleTimeString()}`;
        }

        function exportUserData() {
            try {
                showProgress('export', true);
                showStatus('exportStatus', 'Preparing export...', 'info');

                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                const includeEncryption = document.getElementById('export-encrypt').checked;

                setTimeout(() => {
                    try {
                        const exportData = userManager.exportAllUserData(format, includeEncryption);
                        const filename = userManager.generateExportFilename(format, includeEncryption);

                        userManager.downloadExportFile(exportData, filename, format);

                        showProgress('export', false);
                        showStatus('exportStatus', `✅ Data exported successfully as ${filename}`, 'success');

                        // Update data overview
                        loadDataOverview();

                    } catch (error) {
                        showProgress('export', false);
                        showStatus('exportStatus', `❌ Export failed: ${error.message}`, 'error');
                    }
                }, 500);

            } catch (error) {
                showProgress('export', false);
                showStatus('exportStatus', `❌ Export failed: ${error.message}`, 'error');
            }
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            const importBtn = document.getElementById('importBtn');

            if (selectedFile) {
                importBtn.disabled = false;
                showStatus('importStatus', `File selected: ${selectedFile.name}`, 'info');
            } else {
                importBtn.disabled = true;
                hideStatus('importStatus');
            }
        }

        function importUserData() {
            if (!selectedFile) {
                showStatus('importStatus', '❌ Please select a file first', 'error');
                return;
            }

            if (!confirm('⚠️ This will replace all your current data. Are you sure you want to continue?')) {
                return;
            }

            showProgress('import', true);
            showStatus('importStatus', 'Reading file...', 'info');

            const reader = new FileReader();
            const isEncrypted = document.getElementById('import-encrypted').checked;

            reader.onload = function(e) {
                try {
                    showStatus('importStatus', 'Importing data...', 'info');

                    setTimeout(() => {
                        const result = userManager.importAllUserData(e.target.result, isEncrypted);

                        showProgress('import', false);

                        if (result.success) {
                            showStatus('importStatus', `✅ Data imported successfully! Welcome back, ${result.playerName}`, 'success');

                            // Reload the page to reflect imported data
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            showStatus('importStatus', `❌ Import failed: ${result.message}`, 'error');
                        }
                    }, 1000);

                } catch (error) {
                    showProgress('import', false);
                    showStatus('importStatus', `❌ Import failed: ${error.message}`, 'error');
                }
            };

            reader.onerror = function() {
                showProgress('import', false);
                showStatus('importStatus', '❌ Failed to read file', 'error');
            };

            reader.readAsText(selectedFile);
        }

        function viewRawData() {
            const rawData = {
                currentPlayer: userManager.getCurrentPlayer(),
                scenarios: userManager.getStoredData('fiquest_scenarios'),
                netWorthSetup: userManager.getStoredData('fiquest_net_worth_setup'),
                netWorthEntries: userManager.getNetWorthEntries()
            };

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head><title>FIQuest Raw Data</title></head>
                    <body>
                        <h1>FIQuest Raw Data</h1>
                        <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">
${JSON.stringify(rawData, null, 2)}
                        </pre>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

        function validateData() {
            showStatus('managementStatus', 'Validating data integrity...', 'info');

            setTimeout(() => {
                try {
                    const dataInfo = userManager.getDataManagementInfo();
                    const currentPlayer = userManager.getCurrentPlayer();

                    let issues = [];

                    // Check for required data
                    if (!currentPlayer) issues.push('No active player found');
                    if (!currentPlayer.playerName) issues.push('Player name is missing');
                    if (!currentPlayer.gameData) issues.push('Game data is missing');

                    // Check scenarios
                    const scenarios = userManager.getStoredData('fiquest_scenarios');
                    if (scenarios && !Array.isArray(scenarios)) issues.push('Scenarios data is corrupted');

                    // Check net worth data
                    const netWorthEntries = userManager.getNetWorthEntries();
                    if (netWorthEntries && !Array.isArray(netWorthEntries)) issues.push('Net worth entries are corrupted');

                    if (issues.length === 0) {
                        showStatus('managementStatus', '✅ Data validation passed - no issues found', 'success');
                    } else {
                        showStatus('managementStatus', `⚠️ Found ${issues.length} issue(s): ${issues.join(', ')}`, 'error');
                    }

                } catch (error) {
                    showStatus('managementStatus', `❌ Validation failed: ${error.message}`, 'error');
                }
            }, 500);
        }

        function clearAllData() {
            const confirmation = prompt('⚠️ This will permanently delete ALL your FIQuest data. Type "DELETE ALL DATA" to confirm:');

            if (confirmation === 'DELETE ALL DATA') {
                try {
                    // Clear all FIQuest localStorage data
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('fiquest_')) {
                            localStorage.removeItem(key);
                        }
                    });

                    showStatus('managementStatus', '✅ All data cleared successfully', 'success');

                    // Redirect to start page after delay
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);

                } catch (error) {
                    showStatus('managementStatus', `❌ Failed to clear data: ${error.message}`, 'error');
                }
            } else if (confirmation !== null) {
                showStatus('managementStatus', '❌ Confirmation text did not match. Data not cleared.', 'error');
            }
        }

        function showProgress(type, show) {
            const progressBar = document.getElementById(`${type}Progress`);
            if (show) {
                progressBar.style.display = 'block';
                const fill = progressBar.querySelector('.progress-bar-fill');
                fill.style.width = '0%';

                // Animate progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 90) {
                        clearInterval(interval);
                        fill.style.width = '90%';
                    } else {
                        fill.style.width = progress + '%';
                    }
                }, 200);

            } else {
                progressBar.style.display = 'none';
                progressBar.querySelector('.progress-bar-fill').style.width = '100%';
            }
        }

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info'}`;
            statusElement.style.display = 'block';
        }

        function hideStatus(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        // Toggle Initial Setup section
        function toggleInitialSetup(event) {
            event.preventDefault();

            const section = document.getElementById('initial-setup-section');
            const arrow = document.getElementById('setup-arrow');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }
    </script>
</body>
</html>